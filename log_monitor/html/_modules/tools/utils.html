<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>tools.utils &mdash; Brand Nudge Data Collect  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Brand Nudge Data Collect
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../index.html">Home</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools.html">Tools package</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Brand Nudge Data Collect</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">tools.utils</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for tools.utils</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">A class that provides generic reusable features for data collect.</span>

<span class="sd">This class is designed to provide common functionality that can be used across</span>
<span class="sd">different Python programs.</span>
<span class="sd">It includes methods for handling error logging, string manipulation,</span>
<span class="sd">data conversion, and more.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">urlencode</span><span class="p">,</span> <span class="n">urlparse</span>

<span class="kn">import</span> <span class="nn">boto3</span>
<span class="kn">import</span> <span class="nn">psycopg2</span>
<span class="kn">import</span> <span class="nn">psycopg2.extras</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>
<span class="kn">from</span> <span class="nn">psycopg2</span> <span class="kn">import</span> <span class="n">errors</span><span class="p">,</span> <span class="n">OperationalError</span>
<span class="kn">from</span> <span class="nn">zenrows</span> <span class="kn">import</span> <span class="n">ZenRowsClient</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">constants</span>
<span class="k">except</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">constants</span>
<span class="kn">import</span> <span class="nn">pytz</span>

<span class="n">load_dotenv</span><span class="p">()</span>
<span class="n">zenrows_client</span> <span class="o">=</span> <span class="n">ZenRowsClient</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;ZENROWS_API&quot;</span><span class="p">),</span> <span class="n">retries</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">requests</span><span class="o">.</span><span class="n">adapters</span><span class="o">.</span><span class="n">DEFAULT_RETRIES</span> <span class="o">=</span> <span class="mi">5</span>
<span class="kn">from</span> <span class="nn">requests.packages.urllib3.exceptions</span> <span class="kn">import</span> <span class="n">InsecureRequestWarning</span>

<span class="n">UniqueViolation</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="s1">&#39;23505&#39;</span><span class="p">)</span>
<span class="n">requests</span><span class="o">.</span><span class="n">packages</span><span class="o">.</span><span class="n">urllib3</span><span class="o">.</span><span class="n">disable_warnings</span><span class="p">(</span><span class="n">InsecureRequestWarning</span><span class="p">)</span>
<span class="n">SLACK_WEBHOOK</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SLACK_WEBHOOK&quot;</span><span class="p">)</span>
<span class="n">TIMEZONE</span> <span class="o">=</span> <span class="n">pytz</span><span class="o">.</span><span class="n">timezone</span><span class="p">(</span><span class="s1">&#39;UTC&#39;</span><span class="p">)</span>

<span class="n">CLICKUP_HEADERS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;CLICKUP_API&quot;</span><span class="p">)</span>
<span class="p">}</span>
<span class="n">BN_AUTH_HEADERS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;authority&#39;</span><span class="p">:</span> <span class="s1">&#39;api2.brandnudge-platform.com&#39;</span><span class="p">,</span>
    <span class="s1">&#39;accept&#39;</span><span class="p">:</span> <span class="s1">&#39;application/json, text/plain, */*&#39;</span><span class="p">,</span>
    <span class="s1">&#39;accept-language&#39;</span><span class="p">:</span> <span class="s1">&#39;en-GB,en-US;q=0.9,en;q=0.8&#39;</span><span class="p">,</span>
    <span class="s1">&#39;authorization&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="s1">&#39;content-type&#39;</span><span class="p">:</span> <span class="s1">&#39;application/json;charset=UTF-8&#39;</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">CLICKUP_LIST_ID</span> <span class="o">=</span> <span class="s2">&quot;901202285787&quot;</span>
<span class="c1"># S3 for Ingest</span>
<span class="n">AWS_REGION</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;AWSREGION&quot;</span><span class="p">)</span>
<span class="n">AWS_INGEST_ACCESS_KEY_ID</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;AWS_INGEST_ACCESS_KEY_ID&quot;</span><span class="p">)</span>
<span class="n">AWS_INGEST_SECRET_ACCESS_KEY</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;AWS_INGEST_SECRET_ACCESS_KEY&quot;</span><span class="p">)</span>
<span class="n">AWS_INGEST_BUCKET</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;AWS_INGEST_BUCKET&quot;</span><span class="p">)</span>
<span class="c1"># S3 for banner</span>
<span class="n">AWS_BANNER_SCREENSHOTS_REGION</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;AWS_BANNER_SCREENSHOTS_REGION&quot;</span><span class="p">)</span>
<span class="n">AWS_BANNER_SCREENSHOTS_ACCESS_KEY_ID</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;AWS_BANNER_SCREENSHOTS_ACCESS_KEY_ID&quot;</span><span class="p">)</span>
<span class="n">AWS_BANNER_SCREENSHOTS_SECRET_ACCESS_KEY</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;AWS_BANNER_SCREENSHOTS_SECRET_ACCESS_KEY&quot;</span><span class="p">)</span>
<span class="c1"># BM API Credentials</span>
<span class="n">ADMIN_API_USER</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;ADMIN_API_USER&quot;</span><span class="p">)</span>
<span class="n">ADMIN_API_PASS</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;ADMIN_API_PASS&quot;</span><span class="p">)</span>
<span class="c1"># BN API URL</span>
<span class="n">BN_AUTH_URL</span> <span class="o">=</span> <span class="s2">&quot;https://api2.brandnudge-platform.com/auth/login&quot;</span>
<span class="n">BN_API_URL</span> <span class="o">=</span> <span class="s2">&quot;http://api2.brandnudge-platform.com/scraper&quot;</span>

<span class="n">DEBUG</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;DEBUG&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>


<div class="viewcode-block" id="LogHandler">
<a class="viewcode-back" href="../../tools.html#tools.utils.LogHandler">[docs]</a>
<span class="k">class</span> <span class="nc">LogHandler</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class for logging errors and Slack messages.</span>

<span class="sd">    This class provides methods for logging various types of errors and messages.</span>
<span class="sd">    It uses the standard logging module to write error messages to a file or database</span>
<span class="sd">    and the Slack API to push messages to a defined Slack channel</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="LogHandler.create_log_table">
<a class="viewcode-back" href="../../tools.html#tools.utils.LogHandler.create_log_table">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">create_log_table</span><span class="p">(</span><span class="n">connection</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Executes an initial SQL statement on the given database connection and creates the log table.</span>

<span class="sd">        This method executes an initial SQL statement defined in `constants.initial_sql` using the provided</span>
<span class="sd">        database connection. It commits the transaction after executing the statement and then closes the cursor.</span>
<span class="sd">        Any exceptions raised during this process should be handled by the calling code.</span>

<span class="sd">        :param connection: A database connection object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">connection_cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">connection_cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">initial_sql</span><span class="p">)</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="LogHandler.create_exception_table">
<a class="viewcode-back" href="../../tools.html#tools.utils.LogHandler.create_exception_table">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">create_exception_table</span><span class="p">(</span><span class="n">connection</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Executes an exception SQL statement on the given database connection and creates the exception_logs table.</span>

<span class="sd">        This method executes an exception SQL statement defined in `constants.exception_sql` using the provided</span>
<span class="sd">        database connection. It commits the transaction after executing the statement and then closes the cursor.</span>
<span class="sd">        Any exceptions raised during this process should be handled by the calling code.</span>

<span class="sd">        :param connection: A database connection object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">connection_cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">connection_cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">exception_sql</span><span class="p">)</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="LogHandler.create_cron_table">
<a class="viewcode-back" href="../../tools.html#tools.utils.LogHandler.create_cron_table">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">create_cron_table</span><span class="p">(</span><span class="n">connection</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Executes a cron SQL statement on the given database connection and creates the cron_logs table.</span>

<span class="sd">        This method executes an exception SQL statement defined in `constants.cron_table` using the provided</span>
<span class="sd">        database connection. It commits the transaction after executing the statement and then closes the cursor.</span>
<span class="sd">        Any exceptions raised during this process should be handled by the calling code.</span>

<span class="sd">        :param connection: A database connection object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">connection_cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">connection_cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">cron_table</span><span class="p">)</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="LogHandler.create_debug_table">
<a class="viewcode-back" href="../../tools.html#tools.utils.LogHandler.create_debug_table">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">create_debug_table</span><span class="p">(</span><span class="n">connection</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Executes a debug SQL statement on the given database connection and creates the debug_logs table.</span>

<span class="sd">        This method executes an exception SQL statement defined in `constants.debug_table` using the provided</span>
<span class="sd">        database connection. It commits the transaction after executing the statement and then closes the cursor.</span>
<span class="sd">        Any exceptions raised during this process should be handled by the calling code.</span>

<span class="sd">        :param connection: A database connection object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">connection_cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">connection_cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">debug_table</span><span class="p">)</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="LogHandler.error_db">
<a class="viewcode-back" href="../../tools.html#tools.utils.LogHandler.error_db">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">error_db</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">sys_info</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Logs an error message to the database for the specified retailer.</span>

<span class="sd">        This method logs an error message to a database for the given retailer. It extracts the function name</span>
<span class="sd">        and line number from the traceback, redacts any API keys in the error message, and creates an error record.</span>
<span class="sd">        It then establishes a database connection, checks if the log table exists (and creates it if not),</span>
<span class="sd">        and inserts the error record into the log table. After committing the transaction, the cursor is closed.</span>
<span class="sd">        Any exceptions raised during this process are silently ignored.</span>

<span class="sd">        :param retailer: The name of the retailer.</span>
<span class="sd">        :param message: The error message to be logged.</span>
<span class="sd">        :param sys_info: System information, typically obtained from `sys.exc_info()`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">tb</span> <span class="o">=</span> <span class="n">sys_info</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">stk</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">extract_tb</span><span class="p">(</span><span class="n">tb</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">function_name</span> <span class="o">=</span> <span class="n">stk</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">lineno</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">tb_lineno</span>
            <span class="n">error_record</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;Created&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
                <span class="s2">&quot;Name&quot;</span><span class="p">:</span> <span class="n">retailer</span><span class="p">,</span>
                <span class="s2">&quot;Level&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s2">&quot;Message&quot;</span><span class="p">:</span> <span class="n">Utils</span><span class="o">.</span><span class="n">redact_api_key</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">message</span><span class="p">)),</span>
                <span class="s2">&quot;Function&quot;</span><span class="p">:</span> <span class="n">function_name</span><span class="p">,</span>
                <span class="s2">&quot;LineNo&quot;</span><span class="p">:</span> <span class="n">lineno</span>
            <span class="p">}</span>

            <span class="n">connection</span> <span class="o">=</span> <span class="n">Utils</span><span class="o">.</span><span class="n">create_db_con</span><span class="p">()</span>
            <span class="n">connection_cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
            <span class="c1"># Let&#39;s check if the log table exist and create if not</span>
            <span class="n">LogHandler</span><span class="o">.</span><span class="n">create_log_table</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
            <span class="n">connection_cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">insertion_sql</span><span class="p">,</span> <span class="n">error_record</span><span class="p">)</span>

            <span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span></div>


<div class="viewcode-block" id="LogHandler.error_file">
<a class="viewcode-back" href="../../tools.html#tools.utils.LogHandler.error_file">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">error_file</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">sys_info</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Logs an error message to a local file called scrapers.log.</span>

<span class="sd">        This method logs an error message to a file for the given retailer. It sets up logging configuration with the</span>
<span class="sd">        specified format, filename, and logging level. The method extracts the function name and line number from the</span>
<span class="sd">        traceback, redacts any API keys in the error message, and logs the error message to the file with details</span>
<span class="sd">        including retailer, function name, and line number.</span>

<span class="sd">        :param retailer: The name of the retailer.</span>
<span class="sd">        :param message: The error message to be logged.</span>
<span class="sd">        :param sys_info: System information, typically obtained from `sys.exc_info()`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>
            <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;scrapers.log&#39;</span><span class="p">,</span>
            <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
            <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1">.</span><span class="si">%(msecs)03d</span><span class="s1"> </span><span class="si">%(levelname)s</span><span class="s1"> </span><span class="si">%(module)s</span><span class="s1"> - </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="n">datefmt</span><span class="o">=</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">tb</span> <span class="o">=</span> <span class="n">sys_info</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">stk</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">extract_tb</span><span class="p">(</span><span class="n">tb</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">function_name</span> <span class="o">=</span> <span class="n">stk</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">lineno</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">tb_lineno</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Retailer: </span><span class="si">{</span><span class="n">retailer</span><span class="si">}</span><span class="s2">, Message: </span><span class="si">{</span><span class="n">Utils</span><span class="o">.</span><span class="n">redact_api_key</span><span class="p">(</span><span class="n">message</span><span class="p">)</span><span class="si">}</span><span class="s2">, Function: </span><span class="si">{</span><span class="n">function_name</span><span class="si">}</span><span class="s2">, Line Nr: </span><span class="si">{</span><span class="n">lineno</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="LogHandler.debug_file">
<a class="viewcode-back" href="../../tools.html#tools.utils.LogHandler.debug_file">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">debug_file</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Logs debugging messages to a local file called debug.log.</span>

<span class="sd">        This method appends a debug message to a log file specific to the retailer.</span>
<span class="sd">        The log entry includes the current datetime, the retailer&#39;s name, and the message.</span>
<span class="sd">        The log file is named in the format &#39;{retailer}_debug.log&#39;.</span>

<span class="sd">        :param retailer: The name of the retailer.</span>
<span class="sd">        :param message: The error message to be logged.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">retailer</span><span class="si">}</span><span class="s2">_debug.log&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">retailer</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="LogHandler.error_exception_report">
<a class="viewcode-back" href="../../tools.html#tools.utils.LogHandler.error_exception_report">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">error_exception_report</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Log failed urls to the exception report table</span>

<span class="sd">        This method logs an exception url to a database for the given retailer. It creates an error record with the</span>
<span class="sd">        current datetime, retailer&#39;s name, URL, and the exception message. It then establishes a database connection,</span>
<span class="sd">        checks if the exception log table exists (and creates it if not), and inserts the error record into the</span>
<span class="sd">        exception log table. After committing the transaction, the cursor is closed.</span>

<span class="sd">        :param retailer: The name of the retailer.</span>
<span class="sd">        :param url: Failed URL</span>
<span class="sd">        :param message: The error message to be logged.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">error_record</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;Created&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
            <span class="s2">&quot;Name&quot;</span><span class="p">:</span> <span class="n">retailer</span><span class="p">,</span>
            <span class="s2">&quot;Url&quot;</span><span class="p">:</span> <span class="n">url</span><span class="p">,</span>
            <span class="s2">&quot;Message&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">message</span><span class="p">),</span>
        <span class="p">}</span>

        <span class="n">connection</span> <span class="o">=</span> <span class="n">Utils</span><span class="o">.</span><span class="n">create_db_con</span><span class="p">()</span>
        <span class="n">connection_cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="c1"># Let&#39;s check if the exception log table exist and create if not</span>
        <span class="n">LogHandler</span><span class="o">.</span><span class="n">create_exception_table</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
        <span class="n">connection_cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">insert_exception_sql</span><span class="p">,</span> <span class="n">error_record</span><span class="p">)</span>

        <span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="LogHandler.error_slack">
<a class="viewcode-back" href="../../tools.html#tools.utils.LogHandler.error_slack">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">error_slack</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">message_type</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Send a Slack message to a channel via a webhook.</span>

<span class="sd">        This method sends a Slack notification for the given retailer based on the provided message type.</span>
<span class="sd">        If the message type is &#39;error&#39;, a notification about an error is sent, including the retailer&#39;s name</span>
<span class="sd">        and the error message. If the message type is &#39;stats&#39;, a statistics report is sent, including various</span>
<span class="sd">        statistics about the retailer&#39;s data collection process, such as navigation links count, product count,</span>
<span class="sd">        duration, and failed URLs.</span>

<span class="sd">        :param retailer: The name of the retailer.</span>
<span class="sd">        :param message: The message to be sent. It can be either a string or a dictionary.</span>
<span class="sd">        :param message_type: The type of message to be sent. It can be either &#39;error&#39; or &#39;stats&#39;.</span>
<span class="sd">        :return: The response object from the Slack API request.</span>
<span class="sd">        :rtype: requests.Response</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">message_type</span> <span class="o">==</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;Error&quot;</span><span class="p">,</span>
                <span class="s2">&quot;blocks&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;section&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="p">{</span>
                            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;mrkdwn&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;*Error*&quot;</span>
                        <span class="p">}</span>
                    <span class="p">},</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;divider&quot;</span>
                    <span class="p">},</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;section&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;block_id&quot;</span><span class="p">:</span> <span class="s2">&quot;section567&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="p">{</span>
                            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;mrkdwn&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;*Retailer:* </span><span class="si">{</span><span class="n">retailer</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                                    <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> *Message:* </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">},</span>
                    <span class="p">},</span>
                <span class="p">]</span>
            <span class="p">}</span>
        <span class="k">elif</span> <span class="n">message_type</span> <span class="o">==</span> <span class="s2">&quot;stats&quot;</span><span class="p">:</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;Statistics Report&quot;</span><span class="p">,</span>
                <span class="s2">&quot;blocks&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;section&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="p">{</span>
                            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;mrkdwn&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;*Statistics Report*&quot;</span>
                        <span class="p">}</span>
                    <span class="p">},</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;divider&quot;</span>
                    <span class="p">},</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;section&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;block_id&quot;</span><span class="p">:</span> <span class="s2">&quot;section567&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="p">{</span>
                            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;mrkdwn&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;*Retailer:* </span><span class="si">{</span><span class="n">retailer</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                                    <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> *Main Navigation Links:* </span><span class="si">{</span><span class="n">message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Navigation_count&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;N/a&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                                    <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> *Expected Navigation Links:* </span><span class="si">{</span><span class="n">message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Navigation_url_count&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;N/a&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                                    <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> *Products Collected:* </span><span class="si">{</span><span class="n">message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Item_counter&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;N/a&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                                    <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> *Duration:* </span><span class="si">{</span><span class="n">Utils</span><span class="o">.</span><span class="n">time_format</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Duration&#39;</span><span class="p">,</span><span class="w"> </span><span class="kc">None</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span>
                                    <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> *Failed URLS:* </span><span class="si">{</span><span class="n">message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Failed_URLS&#39;</span><span class="p">,</span><span class="w"> </span><span class="kc">None</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">},</span>
                    <span class="p">},</span>
                <span class="p">]</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">SLACK_WEBHOOK</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span></div>


<div class="viewcode-block" id="LogHandler.cron_logs">
<a class="viewcode-back" href="../../tools.html#tools.utils.LogHandler.cron_logs">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">cron_logs</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Logs cron job data to the database.</span>

<span class="sd">        This method logs cron job data to the database. It creates a connection to the database,</span>
<span class="sd">        checks if the cron table exists (and creates it if not), and inserts each line from the provided</span>
<span class="sd">        list into the cron table along with the current datetime. If an error occurs during this process,</span>
<span class="sd">        it is logged to both the database and a file, and the method continues execution.</span>

<span class="sd">        :param lines: List of lines to be logged.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">connection</span> <span class="o">=</span> <span class="n">Utils</span><span class="o">.</span><span class="n">create_db_con</span><span class="p">()</span>
            <span class="n">connection_cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
            <span class="c1"># Let&#39;s check if the cron table exist and create if not</span>
            <span class="n">LogHandler</span><span class="o">.</span><span class="n">create_cron_table</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span> <span class="n">line</span><span class="p">]</span>
                <span class="n">connection_cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">cron_insertion</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
                <span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Log to DB</span>
            <span class="n">LogHandler</span><span class="o">.</span><span class="n">error_db</span><span class="p">(</span><span class="s2">&quot;cron&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
            <span class="c1"># Log to file</span>
            <span class="n">LogHandler</span><span class="o">.</span><span class="n">error_file</span><span class="p">(</span><span class="s2">&quot;cron&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
            <span class="k">pass</span></div>


<div class="viewcode-block" id="LogHandler.debug_logs">
<a class="viewcode-back" href="../../tools.html#tools.utils.LogHandler.debug_logs">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">debug_logs</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Logs a debug message to the database for the specified retailer.</span>

<span class="sd">        This method logs a debug message to the database for the given retailer. It creates a connection to the</span>
<span class="sd">        database, checks if the debug table exists (and creates it if not), and inserts the debug message along</span>
<span class="sd">        with the current datetime and retailer&#39;s name into the debug table. If an error occurs during this process,</span>
<span class="sd">        it is logged to both the database and a file, and the method continues execution.</span>

<span class="sd">        :param retailer: The name of the retailer.</span>
<span class="sd">        :param message: The debug message to be logged.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">connection</span> <span class="o">=</span> <span class="n">Utils</span><span class="o">.</span><span class="n">create_db_con</span><span class="p">()</span>
            <span class="n">connection_cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
            <span class="c1"># Let&#39;s check if the debug table exist and create if not</span>
            <span class="n">LogHandler</span><span class="o">.</span><span class="n">create_debug_table</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>

            <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span> <span class="n">retailer</span><span class="p">,</span> <span class="n">message</span><span class="p">]</span>
            <span class="n">connection_cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">debug_insertion</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
            <span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Log to DB</span>
            <span class="n">LogHandler</span><span class="o">.</span><span class="n">error_db</span><span class="p">(</span><span class="s2">&quot;debug&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
            <span class="c1"># Log to file</span>
            <span class="n">LogHandler</span><span class="o">.</span><span class="n">error_file</span><span class="p">(</span><span class="s2">&quot;debug&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
            <span class="k">pass</span></div>
</div>



<div class="viewcode-block" id="Statistics">
<a class="viewcode-back" href="../../tools.html#tools.utils.Statistics">[docs]</a>
<span class="k">class</span> <span class="nc">Statistics</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A collection of methods used to store statistical data.</span>

<span class="sd">    This class contains a variety of methods for storing statistical data,</span>
<span class="sd">    from creating the tables to inserting the data.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Statistics.create_stats_table">
<a class="viewcode-back" href="../../tools.html#tools.utils.Statistics.create_stats_table">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">create_stats_table</span><span class="p">(</span><span class="n">connection</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Executes a stats SQL statement on the given database connection and creates the statistics table.</span>

<span class="sd">        This method executes an exception SQL statement defined in `constants.initial_stats` using the provided</span>
<span class="sd">        database connection. It commits the transaction after executing the statement and then closes the cursor.</span>
<span class="sd">        Any exceptions raised during this process should be handled by the calling code.</span>

<span class="sd">        :param connection: A database connection object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">connection_cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">connection_cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">initial_stats</span><span class="p">)</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="Statistics.log_to_db">
<a class="viewcode-back" href="../../tools.html#tools.utils.Statistics.log_to_db">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">log_to_db</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">stats</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Logs statistics to the database for the specified retailer by calling</span>
<span class="sd">        the appropriate stored procedure.</span>

<span class="sd">        This method logs statistical data to the database for the given retailer.</span>
<span class="sd">        It establishes a database connection, ensures the statistics table exists</span>
<span class="sd">        (and creates it if not), and then calls the appropriate stored procedure based</span>
<span class="sd">        on the retailer&#39;s name. The stored procedures handle specific retailers like</span>
<span class="sd">        &quot;Reviews&quot;, &quot;Carrefour FR&quot;, and &quot;Amazon&quot;, while a default stored procedure is</span>
<span class="sd">        used for others. The statistics data includes navigation counts, duration,</span>
<span class="sd">        failed URLs, and table name.</span>

<span class="sd">        :param retailer: The name of the retailer.</span>
<span class="sd">        :param stats: A dictionary containing statistical data to be logged. Expected keys are:</span>
<span class="sd">            - &quot;Navigation_count&quot;: int</span>
<span class="sd">            - &quot;Navigation_url_count&quot;: int</span>
<span class="sd">            - &quot;Duration&quot;: str</span>
<span class="sd">            - &quot;Failed_URLS&quot;: list</span>
<span class="sd">            - &quot;Table_Name&quot;: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">connection</span> <span class="o">=</span> <span class="n">Utils</span><span class="o">.</span><span class="n">create_db_con</span><span class="p">()</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">autocommit</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="c1"># Let&#39;s check if the log table exist and create if not</span>
        <span class="n">Statistics</span><span class="o">.</span><span class="n">create_stats_table</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;Reviews&quot;</span> <span class="ow">in</span> <span class="n">retailer</span><span class="p">:</span>
            <span class="n">sp</span> <span class="o">=</span> <span class="s2">&quot;imports_today_reviews&quot;</span>
        <span class="k">elif</span> <span class="s2">&quot;Carrefour FR&quot;</span> <span class="ow">in</span> <span class="n">retailer</span><span class="p">:</span>
            <span class="n">sp</span> <span class="o">=</span> <span class="s2">&quot;imports_today_carrefour&quot;</span>
        <span class="k">elif</span> <span class="s2">&quot;Amazon&quot;</span> <span class="ow">in</span> <span class="n">retailer</span><span class="p">:</span>
            <span class="n">sp</span> <span class="o">=</span> <span class="s2">&quot;imports_today_amazon&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sp</span> <span class="o">=</span> <span class="s2">&quot;imports_today&quot;</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;CALL </span><span class="si">{</span><span class="n">sp</span><span class="si">}</span><span class="s2">(%s, %s, %s, %s, %s, %s);&quot;</span><span class="p">,</span>
            <span class="p">(</span>
                <span class="n">retailer</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;Navigation_count&quot;</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;Navigation_url_count&quot;</span><span class="p">]),</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">Utils</span><span class="o">.</span><span class="n">time_format</span><span class="p">(</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;Duration&quot;</span><span class="p">])),</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;Failed_URLS&quot;</span><span class="p">]),</span>
                <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;Table_Name&quot;</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="Statistics.statistics">
<a class="viewcode-back" href="../../tools.html#tools.utils.Statistics.statistics">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">statistics</span><span class="p">(</span><span class="n">navigation_counter</span><span class="p">,</span> <span class="n">navigation_url_count</span><span class="p">,</span> <span class="n">item_counter</span><span class="p">,</span> <span class="n">duration</span><span class="p">,</span> <span class="n">urls</span><span class="p">,</span> <span class="n">retailer</span><span class="p">,</span> <span class="n">table_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Processes and logs statistical data for the specified retailer.</span>

<span class="sd">        :param navigation_counter: The count of navigation links processed.</span>
<span class="sd">        :param navigation_url_count: The expected count of navigation links.</span>
<span class="sd">        :param item_counter: The count of items collected.</span>
<span class="sd">        :param duration: The duration of the process.</span>
<span class="sd">        :param urls: List of URLs with their success status.</span>
<span class="sd">        :param retailer: The name of the retailer.</span>
<span class="sd">        :param table_name: The name of the table where data is stored.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">retailer</span> <span class="o">==</span> <span class="s2">&quot;Co-op&quot;</span><span class="p">:</span>
            <span class="n">failed_urls</span> <span class="o">=</span> <span class="n">urls</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">failed_urls</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">urls</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">url</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="n">failed_urls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">url</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">])</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;Navigation_count&quot;</span><span class="p">:</span> <span class="n">navigation_counter</span><span class="p">,</span>
            <span class="s2">&quot;Navigation_url_count&quot;</span><span class="p">:</span> <span class="n">navigation_url_count</span><span class="p">,</span>
            <span class="s2">&quot;Item_counter&quot;</span><span class="p">:</span> <span class="n">item_counter</span><span class="p">,</span>
            <span class="s2">&quot;Duration&quot;</span><span class="p">:</span> <span class="n">duration</span><span class="p">,</span>
            <span class="s2">&quot;Failed_URLS&quot;</span><span class="p">:</span> <span class="n">failed_urls</span><span class="p">,</span>
            <span class="s2">&quot;Table_Name&quot;</span><span class="p">:</span> <span class="n">table_name</span>
        <span class="p">}</span>
        <span class="c1"># Log to Slack</span>
        <span class="n">LogHandler</span><span class="o">.</span><span class="n">error_slack</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">stats</span><span class="p">,</span> <span class="s2">&quot;stats&quot;</span><span class="p">)</span>
        <span class="c1"># Log to DB</span>
        <span class="n">Statistics</span><span class="o">.</span><span class="n">log_to_db</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">stats</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="Utils">
<a class="viewcode-back" href="../../tools.html#tools.utils.Utils">[docs]</a>
<span class="k">class</span> <span class="nc">Utils</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A collection of utility methods for common Python tasks.</span>

<span class="sd">    This class contains a variety of methods that can be reused across different Python scripts</span>
<span class="sd">    and projects. These methods cover a range of tasks, including string manipulation, file</span>
<span class="sd">    handling, data validation, and more.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Utils.create_db_con">
<a class="viewcode-back" href="../../tools.html#tools.utils.Utils.create_db_con">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">create_db_con</span><span class="p">(</span><span class="n">retries</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Establishes a connection to the PostgreSQL database with retry logic.</span>

<span class="sd">        This method attempts to connect to a PostgreSQL database using credentials and connection parameters</span>
<span class="sd">        from environment variables. If the initial connection attempt fails, it retries the specified number</span>
<span class="sd">        of times with a delay between each attempt. If all retries fail, an OperationalError is raised. In case</span>
<span class="sd">        of other exceptions, an error message is logged.</span>

<span class="sd">        :param retries: The number of retry attempts for connecting to the database. Default is 3.</span>
<span class="sd">        :param delay: The delay in seconds between retry attempts. Default is 5.</span>
<span class="sd">        :return: A connection object to the PostgreSQL database.</span>
<span class="sd">        :rtype: psycopg2.extensions.connection</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">attempt</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">attempt</span> <span class="o">&lt;</span> <span class="n">retries</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">connection</span> <span class="o">=</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                        <span class="n">host</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;HOST&quot;</span><span class="p">),</span>
                        <span class="n">database</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;DB&quot;</span><span class="p">),</span>
                        <span class="n">user</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;USERNAME&quot;</span><span class="p">),</span>
                        <span class="n">password</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;PASSWORD&quot;</span><span class="p">),</span>
                        <span class="n">port</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;PORT&quot;</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="k">return</span> <span class="n">connection</span>
                <span class="k">except</span> <span class="n">OperationalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">attempt</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">attempt</span> <span class="o">&gt;=</span> <span class="n">retries</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">OperationalError</span>
                    <span class="n">Utils</span><span class="o">.</span><span class="n">print_debug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;DB Connect&quot;</span><span class="p">,</span>
                                      <span class="sa">f</span><span class="s2">&quot;Connection attempt </span><span class="si">{</span><span class="n">attempt</span><span class="si">}</span><span class="s2"> failed. Retrying in </span><span class="si">{</span><span class="n">delay</span><span class="si">}</span><span class="s2"> seconds...&quot;</span><span class="p">)</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">Utils</span><span class="o">.</span><span class="n">print_error</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;DB Connect&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span></div>


<div class="viewcode-block" id="Utils.time_format">
<a class="viewcode-back" href="../../tools.html#tools.utils.Utils.time_format">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">time_format</span><span class="p">(</span><span class="n">duration</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Formats a given duration in seconds into a human-readable string.</span>

<span class="sd">        This method converts a duration in seconds into a human-readable format. Depending on the length of the duration,</span>
<span class="sd">        it formats the output to show days, hours, minutes, and seconds. The output format varies based on the value of the</span>
<span class="sd">        duration:</span>
<span class="sd">        - Days, hours, minutes, and seconds if the duration is greater than or equal to a day.</span>
<span class="sd">        - Hours, minutes, and seconds if the duration is less than a day but at least an hour.</span>
<span class="sd">        - Minutes and seconds if the duration is less than an hour but at least a minute.</span>
<span class="sd">        - Seconds if the duration is less than a minute but at least one second.</span>
<span class="sd">        - &quot;N/a&quot; if the duration is None.</span>

<span class="sd">        :param duration: The duration in seconds to be formatted. If None, returns &quot;N/a&quot;.</span>
<span class="sd">        :return: The formatted duration string in the format &quot;DD HH mm ss&quot;, &quot;HH mm ss&quot;,</span>
<span class="sd">            &quot;mm ss&quot;, or &quot;ss&quot; as appropriate. Returns &quot;N/a&quot; if the duration is None.</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">duration</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">seconds</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">seconds</span> <span class="o">//</span> <span class="p">(</span><span class="mi">3600</span> <span class="o">*</span> <span class="mi">24</span><span class="p">)</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">seconds</span> <span class="o">//</span> <span class="mi">3600</span> <span class="o">%</span> <span class="mi">24</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">seconds</span> <span class="o">%</span> <span class="mi">3600</span> <span class="o">//</span> <span class="mi">60</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">seconds</span> <span class="o">%</span> <span class="mi">3600</span> <span class="o">%</span> <span class="mi">60</span>
            <span class="k">if</span> <span class="n">d</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;</span><span class="si">{:02d}</span><span class="s1">D </span><span class="si">{:02d}</span><span class="s1">H </span><span class="si">{:02d}</span><span class="s1">m </span><span class="si">{:02d}</span><span class="s1">s&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">h</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;</span><span class="si">{:02d}</span><span class="s1">H </span><span class="si">{:02d}</span><span class="s1">m </span><span class="si">{:02d}</span><span class="s1">s&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">m</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;</span><span class="si">{:02d}</span><span class="s1">m </span><span class="si">{:02d}</span><span class="s1">s&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">s</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;</span><span class="si">{:02d}</span><span class="s1">s&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;N/a&quot;</span></div>


<div class="viewcode-block" id="Utils.insert_to_db">
<a class="viewcode-back" href="../../tools.html#tools.utils.Utils.insert_to_db">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">insert_to_db</span><span class="p">(</span><span class="n">insert_query</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">retailer</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Inserts a row of data into the database with error handling and logging.</span>

<span class="sd">        This method inserts a row of data into the database using the provided SQL insert query. If a unique violation</span>
<span class="sd">        occurs, it silently passes. For other exceptions, it logs the error using the utility functions for debugging,</span>
<span class="sd">        and also logs the error to the database and a file. The method ensures that the database connection and cursor</span>
<span class="sd">        are set up before the insert operation and handles the commit and exception management.</span>

<span class="sd">        :param insert_query: The SQL insert query.</span>
<span class="sd">        :param row: The data to be inserted as a tuple.</span>
<span class="sd">        :param retailer: The name of the retailer associated with the data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">debug</span> <span class="o">=</span> <span class="n">Utils</span><span class="o">.</span><span class="n">setup_debugging</span><span class="p">()</span>
        <span class="n">connection</span> <span class="o">=</span> <span class="n">Utils</span><span class="o">.</span><span class="n">create_db_con</span><span class="p">()</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">insert_query</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span>
            <span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">UniqueViolation</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">Utils</span><span class="o">.</span><span class="n">print_error</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">retailer</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="c1"># Log to DB</span>
            <span class="n">LogHandler</span><span class="o">.</span><span class="n">error_db</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
            <span class="c1"># Log to file</span>
            <span class="n">LogHandler</span><span class="o">.</span><span class="n">error_file</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
            <span class="k">pass</span></div>


<div class="viewcode-block" id="Utils.insert_to_db_batch">
<a class="viewcode-back" href="../../tools.html#tools.utils.Utils.insert_to_db_batch">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">insert_to_db_batch</span><span class="p">(</span><span class="n">insert_query</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">retailer</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Inserts a batch of rows into the database with error handling and logging.</span>

<span class="sd">        This method inserts a batch of rows into the database using the provided SQL insert query. If a unique violation</span>
<span class="sd">        occurs, it silently passes. For other exceptions, it logs the error using the utility functions for debugging,</span>
<span class="sd">        and also logs the error to the database and a file. The method ensures that the database connection and cursor</span>
<span class="sd">        are set up before the insert operation and handles the commit and exception management.</span>

<span class="sd">        The `psycopg2.extras.execute_batch` function is used for efficient batch insertion. If autocommit is required,</span>
<span class="sd">        it can be enabled by uncommenting the `connection.autocommit` line.</span>

<span class="sd">        :param insert_query: The SQL insert query for batch execution.</span>
<span class="sd">        :param batch: A list of tuples, where each tuple represents a row of data to be inserted.</span>
<span class="sd">        :param retailer: The name of the retailer associated with the data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">debug</span> <span class="o">=</span> <span class="n">Utils</span><span class="o">.</span><span class="n">setup_debugging</span><span class="p">()</span>
        <span class="n">connection</span> <span class="o">=</span> <span class="n">Utils</span><span class="o">.</span><span class="n">create_db_con</span><span class="p">()</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># connection.autocommit = True</span>
            <span class="n">psycopg2</span><span class="o">.</span><span class="n">extras</span><span class="o">.</span><span class="n">execute_batch</span><span class="p">(</span><span class="n">cursor</span><span class="p">,</span> <span class="n">insert_query</span><span class="p">,</span> <span class="n">batch</span><span class="p">)</span>
            <span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">UniqueViolation</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">Utils</span><span class="o">.</span><span class="n">print_error</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">retailer</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="c1"># Log to DB</span>
            <span class="n">LogHandler</span><span class="o">.</span><span class="n">error_db</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
            <span class="c1"># Log to file</span>
            <span class="n">LogHandler</span><span class="o">.</span><span class="n">error_file</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
            <span class="k">pass</span></div>


<div class="viewcode-block" id="Utils.make_request">
<a class="viewcode-back" href="../../tools.html#tools.utils.Utils.make_request">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">make_request</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">request_headers</span><span class="p">,</span> <span class="n">proxy</span><span class="p">,</span> <span class="n">retailer</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cookies</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                     <span class="n">delay</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">allow_redirects</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fail_gracefully</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Attempts to fetch a URL with retries, handling errors and logging.</span>

<span class="sd">        This method attempts to fetch the specified URL with a maximum number of retries defined in</span>
<span class="sd">        `constants.MAX_RETRIES`.It handles various request exceptions such as `ProxyError`, `Timeout`,</span>
<span class="sd">        and `ConnectionError`, logging the errors and retrying after a delay. If the request is successful</span>
<span class="sd">        (status code 200) or if `fail_gracefully` is True, it returns the response. If all retries fail,</span>
<span class="sd">        it logs the error to the database and a file, and finally returns None.</span>

<span class="sd">        :param url: The URL to be fetched.</span>
<span class="sd">        :param request_headers: Dictionary of headers to be sent with the request.</span>
<span class="sd">        :param proxy: Dictionary of proxies to be used for the request.</span>
<span class="sd">        :param retailer: The name of the retailer associated with the request.</span>
<span class="sd">        :param verify: Whether to verify SSL certificates.</span>
<span class="sd">        :param timeout: Timeout for the request in seconds.</span>
<span class="sd">        :param params: Dictionary of URL parameters to be sent with the request.</span>
<span class="sd">        :param cookies: Dictionary of cookies to be sent with the request.</span>
<span class="sd">        :param delay: Delay in seconds between retries.</span>
<span class="sd">        :param allow_redirects: Whether to allow redirects.</span>
<span class="sd">        :param fail_gracefully: Whether to return the response even if the status code is not 200.</span>
<span class="sd">        :return: The HTTP response if the request is successful or if fail_gracefully is True.</span>
<span class="sd">            None if all retries fail.</span>
<span class="sd">        :rtype: requests.Response</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">debug</span> <span class="o">=</span> <span class="n">Utils</span><span class="o">.</span><span class="n">setup_debugging</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">MAX_RETRIES</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">request</span><span class="p">(</span>
                    <span class="s2">&quot;GET&quot;</span><span class="p">,</span>
                    <span class="n">url</span><span class="p">,</span>
                    <span class="n">proxies</span><span class="o">=</span><span class="n">proxy</span><span class="p">,</span>
                    <span class="n">headers</span><span class="o">=</span><span class="n">request_headers</span><span class="p">,</span>
                    <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
                    <span class="n">allow_redirects</span><span class="o">=</span><span class="n">allow_redirects</span><span class="p">,</span>
                    <span class="n">verify</span><span class="o">=</span><span class="n">verify</span><span class="p">,</span>
                    <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
                    <span class="n">cookies</span><span class="o">=</span><span class="n">cookies</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">r</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">r</span>
                <span class="k">elif</span> <span class="n">fail_gracefully</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">r</span>
                <span class="n">r</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ProxyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">Utils</span><span class="o">.</span><span class="n">print_error</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">retailer</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="n">constants</span><span class="o">.</span><span class="n">MAX_RETRIES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">LogHandler</span><span class="o">.</span><span class="n">error_exception_report</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                    <span class="n">LogHandler</span><span class="o">.</span><span class="n">error_file</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">Timeout</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">Utils</span><span class="o">.</span><span class="n">print_error</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">retailer</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="n">constants</span><span class="o">.</span><span class="n">MAX_RETRIES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">LogHandler</span><span class="o">.</span><span class="n">error_exception_report</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                    <span class="n">LogHandler</span><span class="o">.</span><span class="n">error_file</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ConnectionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">Utils</span><span class="o">.</span><span class="n">print_error</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">retailer</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="n">constants</span><span class="o">.</span><span class="n">MAX_RETRIES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">LogHandler</span><span class="o">.</span><span class="n">error_exception_report</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                    <span class="n">LogHandler</span><span class="o">.</span><span class="n">error_file</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">Utils</span><span class="o">.</span><span class="n">print_error</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">retailer</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                <span class="c1"># Log to DB</span>
                <span class="n">LogHandler</span><span class="o">.</span><span class="n">error_db</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
                <span class="c1"># Log to file</span>
                <span class="n">LogHandler</span><span class="o">.</span><span class="n">error_file</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span></div>


<div class="viewcode-block" id="Utils.make_request_post">
<a class="viewcode-back" href="../../tools.html#tools.utils.Utils.make_request_post">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">make_request_post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">request_headers</span><span class="p">,</span> <span class="n">proxy</span><span class="p">,</span> <span class="n">retailer</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">cookies</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                          <span class="n">convert</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fail_gracefully</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">original_response</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Attempts to send a POST request to a URL with retries, handling errors and logging.</span>

<span class="sd">        This method attempts to send a POST request to the specified URL with a maximum number of retries defined in</span>
<span class="sd">        `constants.MAX_RETRIES`. It handles various request exceptions such as `ProxyError`, `Timeout`, and</span>
<span class="sd">        `ConnectionError`,logging the errors and retrying after a delay. If the request is successful</span>
<span class="sd">        (status code 200) or if `fail_gracefully` is True, it returns the response. If all retries fail,</span>
<span class="sd">        it logs the error to the database and a file, and returns None if `original_response` is False,</span>
<span class="sd">        otherwise returns the last response.</span>

<span class="sd">        :param url: The URL to send the POST request to.</span>
<span class="sd">        :param request_headers: Dictionary of headers to be sent with the request.</span>
<span class="sd">        :param proxy: Dictionary of proxies to be used for the request.</span>
<span class="sd">        :param retailer: The name of the retailer associated with the request.</span>
<span class="sd">        :param payload: The data to send in the body of the POST request.</span>
<span class="sd">        :param timeout: Timeout for the request in seconds.</span>
<span class="sd">        :param cookies: Dictionary of cookies to be sent with the request.</span>
<span class="sd">        :param delay: Delay in seconds between retries.</span>
<span class="sd">        :param convert: Whether to convert the payload to JSON if it is a dict or list.</span>
<span class="sd">        :param fail_gracefully: Whether to return the response even if the status code is not 200.</span>
<span class="sd">        :param verify: Whether to verify SSL certificates.</span>
<span class="sd">        :param params: Dictionary of URL parameters to be sent with the request.</span>
<span class="sd">        :param original_response: Whether to return the response object even if retries fail.</span>
<span class="sd">        :return: The HTTP response if the request is successful or if fail_gracefully is True.</span>
<span class="sd">            None if all retries fail.</span>
<span class="sd">        :rtype: requests.Response</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">debug</span> <span class="o">=</span> <span class="n">Utils</span><span class="o">.</span><span class="n">setup_debugging</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">dict</span><span class="p">))</span> <span class="ow">and</span> <span class="n">convert</span><span class="p">:</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">MAX_RETRIES</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                    <span class="n">url</span><span class="p">,</span>
                    <span class="n">headers</span><span class="o">=</span><span class="n">request_headers</span><span class="p">,</span>
                    <span class="n">proxies</span><span class="o">=</span><span class="n">proxy</span><span class="p">,</span>
                    <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
                    <span class="n">data</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span>
                    <span class="n">cookies</span><span class="o">=</span><span class="n">cookies</span><span class="p">,</span>
                    <span class="n">verify</span><span class="o">=</span><span class="n">verify</span><span class="p">,</span>
                    <span class="n">params</span><span class="o">=</span><span class="n">params</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">response</span>
                <span class="k">elif</span> <span class="n">fail_gracefully</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">response</span>
                <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>

            <span class="k">except</span> <span class="p">(</span><span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ProxyError</span><span class="p">,</span>
                    <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">Timeout</span><span class="p">,</span>
                    <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ConnectionError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>

                <span class="n">Utils</span><span class="o">.</span><span class="n">print_error</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">retailer</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">attempt</span> <span class="o">==</span> <span class="n">constants</span><span class="o">.</span><span class="n">MAX_RETRIES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">LogHandler</span><span class="o">.</span><span class="n">error_exception_report</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                    <span class="n">LogHandler</span><span class="o">.</span><span class="n">error_file</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>

                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">Utils</span><span class="o">.</span><span class="n">print_error</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">retailer</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                <span class="c1"># Log to DB</span>
                <span class="n">LogHandler</span><span class="o">.</span><span class="n">error_db</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
                <span class="c1"># Log to file</span>
                <span class="n">LogHandler</span><span class="o">.</span><span class="n">error_file</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">response</span> <span class="k">if</span> <span class="n">original_response</span> <span class="k">else</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Utils.zenrows">
<a class="viewcode-back" href="../../tools.html#tools.utils.Utils.zenrows">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">zenrows</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">cookies</span><span class="p">,</span> <span class="n">retailer</span><span class="p">,</span> <span class="n">custom_validation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Attempts to send a GET request to a the ZenRows API with retries, handling errors and logging.</span>

<span class="sd">        This method attempts to send a GET request to the ZenRows APi with a maximum number of retries defined in</span>
<span class="sd">        `constants.MAX_RETRIES`. It handles various request exceptions such as `ProxyError`, `Timeout`, and `</span>
<span class="sd">        ConnectionError`,logging the errors and retrying after a delay. If a custom validation function is provided,</span>
<span class="sd">        it is applied to the response, and if it returns False, the response is not returned. If the request is</span>
<span class="sd">        successful (status code 200) and passes custom validation, it returns the response. If all retries fail</span>
<span class="sd">        or custom validation fails for all attempts, it logs the error to the database and a file, and returns None.</span>

<span class="sd">        :param url: The URL to send the GET request to.</span>
<span class="sd">        :param params: Dictionary of ZenRows parameters to be sent with the request.</span>
<span class="sd">        :param cookies: Dictionary of cookies to be sent with the request.</span>
<span class="sd">        :param retailer: The name of the retailer associated with the request.</span>
<span class="sd">        :param custom_validation: A custom validation function to validate the response (optional)</span>
<span class="sd">        :param headers: Dictionary of headers to be sent with the request.</span>
<span class="sd">        :param delay: Delay in seconds between retries.</span>
<span class="sd">        :return: The HTTP response if the request is successful and passes custom validation.</span>
<span class="sd">            None if all retries fail or custom validation fails for all attempts.</span>
<span class="sd">        :rtype: requests.Response</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">debug</span> <span class="o">=</span> <span class="n">Utils</span><span class="o">.</span><span class="n">setup_debugging</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">MAX_RETRIES</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">zenrows_client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="n">url</span><span class="p">,</span>
                    <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
                    <span class="n">cookies</span><span class="o">=</span><span class="n">cookies</span><span class="p">,</span>
                    <span class="n">headers</span><span class="o">=</span><span class="n">headers</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">r</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">custom_validation</span> <span class="ow">and</span> <span class="nb">callable</span><span class="p">(</span><span class="n">custom_validation</span><span class="p">):</span>
                        <span class="c1"># Perform custom validation on the response</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">custom_validation</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
                            <span class="c1"># If custom validation fails, do not return the response</span>
                            <span class="k">continue</span>
                    <span class="k">return</span> <span class="n">r</span>
                <span class="n">r</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ProxyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">Utils</span><span class="o">.</span><span class="n">print_error</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">retailer</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="n">constants</span><span class="o">.</span><span class="n">MAX_RETRIES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">LogHandler</span><span class="o">.</span><span class="n">error_exception_report</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">],</span> <span class="n">e</span><span class="p">)</span>
                    <span class="n">LogHandler</span><span class="o">.</span><span class="n">error_file</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">Timeout</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">Utils</span><span class="o">.</span><span class="n">print_error</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">retailer</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="n">constants</span><span class="o">.</span><span class="n">MAX_RETRIES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">LogHandler</span><span class="o">.</span><span class="n">error_exception_report</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">],</span> <span class="n">e</span><span class="p">)</span>
                    <span class="n">LogHandler</span><span class="o">.</span><span class="n">error_file</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ConnectionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">Utils</span><span class="o">.</span><span class="n">print_error</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">retailer</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="n">constants</span><span class="o">.</span><span class="n">MAX_RETRIES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">LogHandler</span><span class="o">.</span><span class="n">error_exception_report</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">],</span> <span class="n">e</span><span class="p">)</span>
                    <span class="n">LogHandler</span><span class="o">.</span><span class="n">error_file</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">Utils</span><span class="o">.</span><span class="n">print_error</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">retailer</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                <span class="c1"># Log to DB</span>
                <span class="n">LogHandler</span><span class="o">.</span><span class="n">error_db</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
                <span class="c1"># Log to file</span>
                <span class="n">LogHandler</span><span class="o">.</span><span class="n">error_file</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span></div>


<div class="viewcode-block" id="Utils.get_product_schema">
<a class="viewcode-back" href="../../tools.html#tools.utils.Utils.get_product_schema">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_product_schema</span><span class="p">(</span><span class="n">schema_products</span><span class="p">,</span> <span class="n">search_term</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extracts and cleans a schema product from a list based on a search term.</span>

<span class="sd">        This function iterates over a list of schema products, removes the script tags, and checks if the search term</span>
<span class="sd">        is present in the cleaned schema product. If the search term is found, it returns the cleaned schema product.</span>
<span class="sd">        If the search term is not found in any of the schema products, it returns None.</span>

<span class="sd">        :param schema_products: List of schema products as strings.</span>
<span class="sd">        :param search_term: Term to search for within the cleaned schema products.</span>
<span class="sd">        :return: The cleaned schema product if the search term is found, otherwise None.</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">schema</span> <span class="ow">in</span> <span class="n">schema_products</span><span class="p">:</span>
            <span class="n">schema</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span>
            <span class="n">cleaned_schema_products</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                <span class="s1">&#39;&lt;script type=&quot;application/ld+json&quot;&gt;&#39;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;/script&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">search_term</span> <span class="ow">in</span> <span class="n">cleaned_schema_products</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">cleaned_schema_products</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Utils.remove_html_tags">
<a class="viewcode-back" href="../../tools.html#tools.utils.Utils.remove_html_tags">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">remove_html_tags</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove HTML tags from the given text using regular expressions.</span>

<span class="sd">        This function uses a regular expression pattern to find and replace all HTML tags (including any attributes)</span>
<span class="sd">        with an empty string, effectively cleaning the text content.</span>

<span class="sd">        :param text: The input text containing HTML tags.</span>
<span class="sd">        :return: The text with HTML tags removed.</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">clean</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;&lt;.*?&gt;&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">clean</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span></div>


<div class="viewcode-block" id="Utils.setup_debugging">
<a class="viewcode-back" href="../../tools.html#tools.utils.Utils.setup_debugging">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">setup_debugging</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse command-line arguments related to debugging options.</span>

<span class="sd">        This function uses argparse to parse command-line arguments related to debugging options.</span>
<span class="sd">        It computes a debug level based on the combination of arguments provided and returns the integer value.</span>

<span class="sd">        - &#39;-print&#39;: Increase debug level by 1 if enabled.</span>
<span class="sd">        - &#39;-log&#39;: Increase debug level by 2 if enabled.</span>
<span class="sd">        - &#39;-file&#39;: Increase debug level by 3 if enabled.</span>
<span class="sd">        - &#39;-debug&#39;: Increase debug level by 4 if enabled.</span>
<span class="sd">        - &#39;-noupload&#39;: Increase debug level by 5 if enabled.</span>
<span class="sd">        - &#39;-rerun&#39;: Increase debug level by 10 if enabled.</span>

<span class="sd">        :return: A debug level integer based on the parsed arguments.</span>
<span class="sd">        :rtype: int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-print&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Print debug logging to terminal&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-log&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Enable debug logging to DB table debug_logs&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-file&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Enable debug logging to file pre-pended with &#39;</span>
                                                               <span class="s1">&#39;retailer name e.g. john_lewis_debug.log&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-debug&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Enable debug logging to DB, file and prints&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-noupload&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Disable upload to S3&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-rerun&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Rerun collection&#39;</span><span class="p">)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

        <span class="n">debug</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">print</span><span class="p">:</span>
            <span class="n">debug</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">log</span><span class="p">:</span>
            <span class="n">debug</span> <span class="o">+=</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">file</span><span class="p">:</span>
            <span class="n">debug</span> <span class="o">+=</span> <span class="mi">3</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="n">debug</span> <span class="o">+=</span> <span class="mi">4</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">noupload</span><span class="p">:</span>
            <span class="n">debug</span> <span class="o">+=</span> <span class="mi">5</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">rerun</span><span class="p">:</span>
            <span class="n">debug</span> <span class="o">+=</span> <span class="mi">10</span>
        <span class="k">return</span> <span class="n">debug</span></div>


<div class="viewcode-block" id="Utils.print_debug">
<a class="viewcode-back" href="../../tools.html#tools.utils.Utils.print_debug">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">print_debug</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">retailer</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handle debug messages based on the provided debug level.</span>

<span class="sd">        - debug == 1: Print the message to terminal with green color.</span>
<span class="sd">        - debug == 2: Log the message to the DB using LogHandler.debug_logs().</span>
<span class="sd">        - debug == 3: Log the message to a file using LogHandler.debug_file().</span>
<span class="sd">        - debug == 4: Print the message to terminal with green color and log to both DB and file.</span>
<span class="sd">        - debug == 6: Print the message to terminal with green color.</span>
<span class="sd">        - Other values: No action is taken.</span>

<span class="sd">        This function handles debug messages based on the debug level provided. Depending on the debug level:</span>
<span class="sd">        - It may print messages to the terminal with color coding.</span>
<span class="sd">        - It may log messages to a database or a file using appropriate methods from LogHandler.</span>
<span class="sd">        - If the debug level doesn&#39;t match any defined cases, it performs no action.</span>

<span class="sd">        :param debug: Debug level integer indicating the type of debug actions to perform.</span>
<span class="sd">        :param retailer: Name of the retailer associated with the debug message.</span>
<span class="sd">        :param message: Debug message to be logged or printed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">debug</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">Utils</span><span class="o">.</span><span class="n">print_time</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">retailer</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">constants</span><span class="o">.</span><span class="n">GREEN</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">debug</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">LogHandler</span><span class="o">.</span><span class="n">debug_logs</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">debug</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">LogHandler</span><span class="o">.</span><span class="n">debug_file</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">debug</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">Utils</span><span class="o">.</span><span class="n">print_time</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">retailer</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">constants</span><span class="o">.</span><span class="n">GREEN</span><span class="p">)</span>
            <span class="n">LogHandler</span><span class="o">.</span><span class="n">debug_logs</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
            <span class="n">LogHandler</span><span class="o">.</span><span class="n">debug_file</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">debug</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
            <span class="n">Utils</span><span class="o">.</span><span class="n">print_time</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">retailer</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">constants</span><span class="o">.</span><span class="n">GREEN</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span></div>


<div class="viewcode-block" id="Utils.print_info">
<a class="viewcode-back" href="../../tools.html#tools.utils.Utils.print_info">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">print_info</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">retailer</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handle print messages based on the provided debug level.</span>

<span class="sd">        - debug == 1: Print the message to terminal with green color.</span>
<span class="sd">        - debug == 2: Log the message to the DB using LogHandler.debug_logs().</span>
<span class="sd">        - debug == 3: Log the message to a file using LogHandler.debug_file().</span>
<span class="sd">        - debug == 4: Print the message to terminal with green color and log to both DB and file.</span>
<span class="sd">        - debug == 6: Print the message to terminal with green color.</span>
<span class="sd">        - Other values: No action is taken.</span>

<span class="sd">        This function handles debug messages based on the debug level provided. Depending on the debug level:</span>
<span class="sd">        - It may print messages to the terminal with color coding.</span>
<span class="sd">        - It may log messages to a database or a file using appropriate methods from LogHandler.</span>
<span class="sd">        - If the debug level doesn&#39;t match any defined cases, it performs no action.</span>

<span class="sd">        :param debug: Debug level integer indicating the type of debug actions to perform.</span>
<span class="sd">        :param retailer: Name of the retailer associated with the debug message.</span>
<span class="sd">        :param message: Debug message to be logged or printed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">debug</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">Utils</span><span class="o">.</span><span class="n">print_time</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">retailer</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">constants</span><span class="o">.</span><span class="n">YELLOW</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">debug</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">LogHandler</span><span class="o">.</span><span class="n">debug_logs</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">debug</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">LogHandler</span><span class="o">.</span><span class="n">debug_file</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">debug</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">Utils</span><span class="o">.</span><span class="n">print_time</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">retailer</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">constants</span><span class="o">.</span><span class="n">YELLOW</span><span class="p">)</span>
            <span class="n">LogHandler</span><span class="o">.</span><span class="n">debug_logs</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
            <span class="n">LogHandler</span><span class="o">.</span><span class="n">debug_file</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">debug</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
            <span class="n">Utils</span><span class="o">.</span><span class="n">print_time</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">retailer</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">constants</span><span class="o">.</span><span class="n">YELLOW</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span></div>


<div class="viewcode-block" id="Utils.print_error">
<a class="viewcode-back" href="../../tools.html#tools.utils.Utils.print_error">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">print_error</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">retailer</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handle error messages based on the provided debug level.</span>

<span class="sd">        - debug == 1: Print the message to terminal with green color.</span>
<span class="sd">        - debug == 2: Log the message to the DB using LogHandler.debug_logs().</span>
<span class="sd">        - debug == 3: Log the message to a file using LogHandler.debug_file().</span>
<span class="sd">        - debug == 4: Print the message to terminal with green color and log to both DB and file.</span>
<span class="sd">        - debug == 6: Print the message to terminal with green color.</span>
<span class="sd">        - Other values: No action is taken.</span>

<span class="sd">        This function handles debug messages based on the debug level provided. Depending on the debug level:</span>
<span class="sd">        - It may print messages to the terminal with color coding.</span>
<span class="sd">        - It may log messages to a database or a file using appropriate methods from LogHandler.</span>
<span class="sd">        - If the debug level doesn&#39;t match any defined cases, it performs no action.</span>

<span class="sd">        :param debug: Debug level integer indicating the type of debug actions to perform.</span>
<span class="sd">        :param retailer: Name of the retailer associated with the debug message.</span>
<span class="sd">        :param message: Debug message to be logged or printed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">debug</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">Utils</span><span class="o">.</span><span class="n">print_time</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">retailer</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">constants</span><span class="o">.</span><span class="n">RED</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">debug</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">LogHandler</span><span class="o">.</span><span class="n">debug_logs</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">debug</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">LogHandler</span><span class="o">.</span><span class="n">debug_file</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">debug</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">Utils</span><span class="o">.</span><span class="n">print_time</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">retailer</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">constants</span><span class="o">.</span><span class="n">RED</span><span class="p">)</span>
            <span class="n">LogHandler</span><span class="o">.</span><span class="n">debug_logs</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
            <span class="n">LogHandler</span><span class="o">.</span><span class="n">debug_file</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">debug</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
            <span class="n">Utils</span><span class="o">.</span><span class="n">print_time</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">retailer</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">constants</span><span class="o">.</span><span class="n">RED</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span></div>


<div class="viewcode-block" id="Utils.proxy_country">
<a class="viewcode-back" href="../../tools.html#tools.utils.Utils.proxy_country">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">proxy_country</span><span class="p">(</span><span class="n">proxy_type</span><span class="p">,</span> <span class="n">country_code</span><span class="p">,</span> <span class="n">alpha_2_code</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set up proxy configurations based on the type of proxy specified.</span>

<span class="sd">        Ensure environment variables SMARTPROXY_RESIDENTIAL and SMARTPROXY_DATACENTER are set with appropriate proxy</span>
<span class="sd">        URLs.</span>
<span class="sd">        &#39;COUNTRY_CODE&#39; placeholder in the proxy URLs will be replaced with alpha_2_code or country_code based on</span>
<span class="sd">        proxy_type.</span>
<span class="sd">        TO BE REMOVED ONCE ALL WERE MOVED OVER TO proxy_country_new</span>

<span class="sd">        :param proxy_type: Type of proxy (&#39;Residential&#39; or &#39;Data_center&#39;).</span>
<span class="sd">        :param country_code: Country code for Data_center proxy type.</span>
<span class="sd">        :param alpha_2_code: Alpha-2 country code for Residential proxy type.</span>
<span class="sd">        :return: Alpha-2 country code for Residential proxy type.</span>
<span class="sd">        :rtype: dict or bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">proxy_type</span> <span class="o">==</span> <span class="s2">&quot;Residential&quot;</span><span class="p">:</span>
            <span class="n">proxy</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;http&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SMARTPROXY_RESIDENTIAL&quot;</span><span class="p">),</span>
                <span class="s2">&quot;https&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SMARTPROXY_RESIDENTIAL&quot;</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="k">elif</span> <span class="n">proxy_type</span> <span class="o">==</span> <span class="s2">&quot;Data_center&quot;</span><span class="p">:</span>
            <span class="n">proxy</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;http&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SMARTPROXY_DATACENTER&quot;</span><span class="p">),</span>
                <span class="s2">&quot;https&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SMARTPROXY_DATACENTER&quot;</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">country_proxy</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">proxy</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">proxy_type</span> <span class="o">==</span> <span class="s2">&quot;Residential&quot;</span><span class="p">:</span>
                <span class="n">updated_value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;COUNTRY_CODE&#39;</span><span class="p">,</span> <span class="n">alpha_2_code</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
            <span class="k">elif</span> <span class="n">proxy_type</span> <span class="o">==</span> <span class="s2">&quot;Data_center&quot;</span><span class="p">:</span>
                <span class="n">updated_value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;COUNTRY_CODE&#39;</span><span class="p">,</span> <span class="n">country_code</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
            <span class="n">country_proxy</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">updated_value</span>
        <span class="k">return</span> <span class="n">country_proxy</span></div>


<div class="viewcode-block" id="Utils.proxy_country_new">
<a class="viewcode-back" href="../../tools.html#tools.utils.Utils.proxy_country_new">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">proxy_country_new</span><span class="p">(</span><span class="n">proxy_type</span><span class="p">,</span> <span class="n">country_code</span><span class="p">,</span> <span class="n">alpha_2_code</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set up proxy configurations based on the type of proxy specified.</span>

<span class="sd">        - Ensure environment variables SMARTPROXY_RESIDENTIAL_NEW and SMARTPROXY_DATACENTER_NEW are set with</span>
<span class="sd">            appropriate proxy URLs.</span>
<span class="sd">        - &#39;COUNTRY_CODE&#39; placeholder in the proxy URLs will be replaced with alpha_2_code or country_code based</span>
<span class="sd">            on proxy_type.</span>
<span class="sd">        - &#39;PORT&#39; placeholder in the proxy URLs will be replaced with the corresponding port based on the country_code.</span>

<span class="sd">        :param proxy_type: Type of proxy (&#39;Residential&#39; or &#39;Data_center&#39;).</span>
<span class="sd">        :param country_code: Country code for Data_center proxy type.</span>
<span class="sd">        :param alpha_2_code: Country code for Data_center proxy type.</span>
<span class="sd">        :return: Dictionary containing updated proxy configurations if proxy_type is valid,</span>
<span class="sd">            False if proxy_type is not recognized.</span>
<span class="sd">        :rtype: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">proxy_type</span> <span class="o">==</span> <span class="s2">&quot;Residential&quot;</span><span class="p">:</span>
            <span class="n">proxy</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;http&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SMARTPROXY_RESIDENTIAL_NEW&quot;</span><span class="p">),</span>
                <span class="s2">&quot;https&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SMARTPROXY_RESIDENTIAL_NEW&quot;</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="k">elif</span> <span class="n">proxy_type</span> <span class="o">==</span> <span class="s2">&quot;Data_center&quot;</span><span class="p">:</span>
            <span class="n">proxy</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;http&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SMARTPROXY_DATACENTER_NEW&quot;</span><span class="p">),</span>
                <span class="s2">&quot;https&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SMARTPROXY_DATACENTER_NEW&quot;</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">port</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">PROXY_PORT_MAP</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">country_code</span><span class="p">))</span>

        <span class="n">country_proxy</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">proxy</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">proxy_type</span> <span class="o">==</span> <span class="s2">&quot;Residential&quot;</span><span class="p">:</span>
                <span class="n">updated_value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;COUNTRY_CODE&#39;</span><span class="p">,</span> <span class="n">alpha_2_code</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;PORT&quot;</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">proxy_type</span> <span class="o">==</span> <span class="s2">&quot;Data_center&quot;</span><span class="p">:</span>
                <span class="n">updated_value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;COUNTRY_CODE&#39;</span><span class="p">,</span> <span class="n">country_code</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;PORT&quot;</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
            <span class="n">country_proxy</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">updated_value</span>
        <span class="k">return</span> <span class="n">country_proxy</span></div>


<div class="viewcode-block" id="Utils.read_yaml_config">
<a class="viewcode-back" href="../../tools.html#tools.utils.Utils.read_yaml_config">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">read_yaml_config</span><span class="p">(</span><span class="n">retailer</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load and validate YAML configuration for a retailer.</span>

<span class="sd">        Example:</span>
<span class="sd">        config_data = load_config(&#39;SomeRetailer&#39;)</span>

<span class="sd">        :param retailer: Name of the retailer.</span>
<span class="sd">        :return: Configuration data loaded from the YAML file.</span>
<span class="sd">        :rtype: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">debug</span> <span class="o">=</span> <span class="n">Utils</span><span class="o">.</span><span class="n">setup_debugging</span><span class="p">()</span>
            <span class="n">script_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;tools&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">script_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;config/</span><span class="si">{</span><span class="n">retailer</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">.yaml&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                <span class="n">config_data</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
                <span class="n">required_fields</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;table_name&#39;</span><span class="p">:</span> <span class="s2">&quot;Table name&quot;</span><span class="p">,</span>
                    <span class="s1">&#39;base_url&#39;</span><span class="p">:</span> <span class="s2">&quot;Base URL&quot;</span><span class="p">,</span>
                    <span class="s1">&#39;country_code&#39;</span><span class="p">:</span> <span class="s2">&quot;Country code&quot;</span><span class="p">,</span>
                    <span class="s1">&#39;collections_type&#39;</span><span class="p">:</span> <span class="s2">&quot;Collection type&quot;</span><span class="p">,</span>
                    <span class="s1">&#39;table&#39;</span><span class="p">:</span> <span class="s2">&quot;Table&quot;</span>
                <span class="p">}</span>

                <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">required_fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">config_data</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">][</span><span class="n">field</span><span class="p">]:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2"> required&quot;</span><span class="p">)</span>
            <span class="n">Utils</span><span class="o">.</span><span class="n">print_debug</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">retailer</span><span class="p">,</span> <span class="s2">&quot;Config validation passed&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">config_data</span>
        <span class="k">except</span> <span class="n">yaml</span><span class="o">.</span><span class="n">YAMLError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">Utils</span><span class="o">.</span><span class="n">print_error</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">retailer</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Error in YAML file: </span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">problem_mark</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in YAML file: </span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">problem_mark</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Utils.validate_yaml">
<a class="viewcode-back" href="../../tools.html#tools.utils.Utils.validate_yaml">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">validate_yaml</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validate all YAML files in the &#39;config&#39; directory.</span>

<span class="sd">        This function iterates through all YAML files in the &#39;config&#39; directory,</span>
<span class="sd">        attempts to load each file using yaml.safe_load(), and prints debug messages</span>
<span class="sd">        indicating whether each YAML file is valid or not.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">debug</span> <span class="o">=</span> <span class="n">Utils</span><span class="o">.</span><span class="n">setup_debugging</span><span class="p">()</span>
            <span class="n">script_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;tools&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">script_dir</span><span class="p">,</span> <span class="s2">&quot;config&quot;</span><span class="p">)</span>
            <span class="n">file_list</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="n">file_list</span><span class="p">:</span>
                <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">script_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;tools/</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                    <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
                <span class="n">Utils</span><span class="o">.</span><span class="n">print_debug</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s2">&quot;All&quot;</span><span class="p">,</span> <span class="s2">&quot;All YAML files looks valid.&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">yaml</span><span class="o">.</span><span class="n">YAMLError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in YAML file: </span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">problem_mark</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Utils.print_time">
<a class="viewcode-back" href="../../tools.html#tools.utils.Utils.print_time">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">print_time</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">color</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Print the current timestamp prefixed to the provided text in the specified color.</span>

<span class="sd">        - Uses the current local timestamp in the format &#39;%d-%m %H:%M:%S&#39;.</span>
<span class="sd">        - Prefixes the formatted timestamp with the specified ANSI color code.</span>
<span class="sd">        - Prints the timestamp and text message to the console.</span>

<span class="sd">        :param text: The text message to be printed.</span>
<span class="sd">        :param color: The ANSI color code to be applied to the timestamp.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">now</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">color</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">-%m %H:%M:%S&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">constants</span><span class="o">.</span><span class="n">RESET</span><span class="si">}</span><span class="s2">]&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">now</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">text</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Utils.housekeeping">
<a class="viewcode-back" href="../../tools.html#tools.utils.Utils.housekeeping">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">housekeeping</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">ingest_enabled</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Performs housekeeping tasks for the given retailer, including deleting database records</span>
<span class="sd">        and potentially deleting corresponding files from an S3 bucket.</span>

<span class="sd">        This method deletes rows from the `collections_status` table where the date is the current date</span>
<span class="sd">        and the retailer matches the given retailer. It then optionally deletes corresponding JSON files</span>
<span class="sd">        from an S3 bucket if ingestion is enabled.</span>

<span class="sd">        :param retailer: The retailer for which housekeeping is being performed.</span>
<span class="sd">        :param debug: The debug level for debug information.</span>
<span class="sd">        :param ingest_enabled: A flag indicating whether ingestion is enabled. If True, files are deleted from S3.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                   DELETE</span>
<span class="s2">                   FROM public.collections_status</span>
<span class="s2">                   WHERE DATE(date) = current_date </span>
<span class="s2">                   AND retailer = %s</span>
<span class="s2">                   RETURNING data_file;</span>
<span class="s2">               &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">Utils</span><span class="o">.</span><span class="n">create_db_con</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
            <span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">retailer</span><span class="p">,))</span>
            <span class="c1"># Fetch the data of the deleted rows</span>
            <span class="n">deleted_rows</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
            <span class="c1"># Get the row count</span>
            <span class="n">deleted_count</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">rowcount</span>
            <span class="n">Utils</span><span class="o">.</span><span class="n">print_debug</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">retailer</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Housekeeping deleted </span><span class="si">{</span><span class="n">deleted_count</span><span class="si">}</span><span class="s2"> rows&quot;</span><span class="p">)</span>
            <span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">deleted_rows</span> <span class="ow">and</span> <span class="n">ingest_enabled</span><span class="p">:</span>
            <span class="n">client</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span>
                <span class="s1">&#39;s3&#39;</span><span class="p">,</span>
                <span class="n">region_name</span><span class="o">=</span><span class="n">AWS_REGION</span><span class="p">,</span>
                <span class="n">aws_access_key_id</span><span class="o">=</span><span class="n">AWS_INGEST_ACCESS_KEY_ID</span><span class="p">,</span>
                <span class="n">aws_secret_access_key</span><span class="o">=</span><span class="n">AWS_INGEST_SECRET_ACCESS_KEY</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">deleted_rows</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.json&#39;</span><span class="p">):</span>
                    <span class="c1"># Delete the file</span>
                    <span class="n">client</span><span class="o">.</span><span class="n">delete_object</span><span class="p">(</span><span class="n">Bucket</span><span class="o">=</span><span class="n">AWS_INGEST_BUCKET</span><span class="p">,</span> <span class="n">Key</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Processed/</span><span class="si">{</span><span class="n">row</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">Utils</span><span class="o">.</span><span class="n">print_debug</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">retailer</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">row</span><span class="si">}</span><span class="s2"> deleted&quot;</span><span class="p">)</span>
        <span class="n">Utils</span><span class="o">.</span><span class="n">print_debug</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">retailer</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Housekeeping done&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Utils.set_start_time">
<a class="viewcode-back" href="../../tools.html#tools.utils.Utils.set_start_time">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">set_start_time</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">collections_type</span><span class="p">,</span> <span class="n">ingest_enabled</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Start a data collection process for a retailer and log the process status to the database.</span>

<span class="sd">        - Uses current local time adjusted to a specified timezone (`TIMEZONE`) for `start_time`.</span>
<span class="sd">        - Inserts a new record into the collections_status table with initial values for start_time, retailer,</span>
<span class="sd">          run_status, collections_type, and ingest_enabled.</span>
<span class="sd">        - Prints debug messages based on the debug level set by `Utils.setup_debugging()`.</span>
<span class="sd">        - Handles exceptions such as UniqueViolation and logs errors to the database and file using `LogHandler`.</span>

<span class="sd">        :param retailer: The name or identifier of the retailer for which the collection is being started.</span>
<span class="sd">        :param collections_type: The type of the collection process e.g. core, reviews, ranking.</span>
<span class="sd">        :param ingest_enabled: Indicates whether data ingestion is enabled or disabled for the collection.</span>
<span class="sd">        :return: The ID of the inserted record in the collections_status table.</span>
<span class="sd">        :rtype: int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">datetime</span>

        <span class="n">debug</span> <span class="o">=</span> <span class="n">Utils</span><span class="o">.</span><span class="n">setup_debugging</span><span class="p">()</span>
        <span class="c1"># 1 is print and 10 is rerun - Bad logic indeed!!</span>
        <span class="k">if</span> <span class="n">debug</span> <span class="o">==</span> <span class="mi">11</span><span class="p">:</span>
            <span class="n">Utils</span><span class="o">.</span><span class="n">housekeeping</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">ingest_enabled</span><span class="p">)</span>

        <span class="n">connection</span> <span class="o">=</span> <span class="n">Utils</span><span class="o">.</span><span class="n">create_db_con</span><span class="p">()</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">TIMEZONE</span><span class="p">)</span>
        <span class="n">run_status</span> <span class="o">=</span> <span class="s1">&#39;Running&#39;</span>
        <span class="n">end_time</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">record</span> <span class="o">=</span> <span class="p">[</span><span class="n">start_time</span><span class="p">,</span> <span class="n">retailer</span><span class="p">,</span> <span class="n">run_status</span><span class="p">,</span> <span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">,</span> <span class="n">collections_type</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ingest_enabled</span><span class="p">]</span>

        <span class="n">insert_query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            INSERT INTO public.collections_status(</span>
<span class="s2">            date, retailer, run_status, start_time, end_time, type, data_file, data_length, ingest_enabled)</span>
<span class="s2">            VALUES (</span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">)</span>
<span class="s2">            RETURNING id;</span>
<span class="s2">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">insert_query</span><span class="p">,</span> <span class="n">record</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
            <span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Collection started for </span><span class="si">{</span><span class="n">retailer</span><span class="si">}</span><span class="s2"> with ingest set to &quot;</span> \
                      <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;enabled&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">ingest_enabled</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">True</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;disabled&#39;</span><span class="si">}</span><span class="s2">.&quot;</span>

            <span class="n">Utils</span><span class="o">.</span><span class="n">print_debug</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">retailer</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="n">UniqueViolation</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">Utils</span><span class="o">.</span><span class="n">print_error</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">retailer</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="c1"># Log to DB</span>
            <span class="n">LogHandler</span><span class="o">.</span><span class="n">error_db</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
            <span class="c1"># Log to file</span>
            <span class="n">LogHandler</span><span class="o">.</span><span class="n">error_file</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
            <span class="k">pass</span></div>


<div class="viewcode-block" id="Utils.set_finish">
<a class="viewcode-back" href="../../tools.html#tools.utils.Utils.set_finish">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">set_finish</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">tracking_id</span><span class="p">,</span> <span class="n">data_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data_length</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the status of a data collection process for a retailer in the database.</span>

<span class="sd">        - Retrieves configuration data for the retailer from a YAML file using `Utils.read_yaml_config()`.</span>
<span class="sd">        - Constructs SQL queries based on the `collections_type` retrieved from the config.</span>
<span class="sd">        - Executes SQL queries to fetch and update collection status information in the database.</span>
<span class="sd">        - Logs errors to the database and file using `LogHandler` in case of exceptions.</span>

<span class="sd">        :param retailer: The name or identifier of the retailer for which the collection status is being updated.</span>
<span class="sd">        :param tracking_id: The ID of the collection process status record to update.</span>
<span class="sd">        :param data_file: File name or identifier associated with the collected retailer.</span>
<span class="sd">        :param data_length: Length or size of the collected data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">datetime</span>
        <span class="n">debug</span> <span class="o">=</span> <span class="n">Utils</span><span class="o">.</span><span class="n">setup_debugging</span><span class="p">()</span>
        <span class="n">connection</span> <span class="o">=</span> <span class="n">Utils</span><span class="o">.</span><span class="n">create_db_con</span><span class="p">()</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="c1"># Load yaml config to get retailer&#39;s table</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">Utils</span><span class="o">.</span><span class="n">read_yaml_config</span><span class="p">(</span><span class="n">retailer</span><span class="p">)</span>
        <span class="n">table_name</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;config&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;table_name&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">ingest</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;config&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ingest_enabled&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">collections_type</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;config&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;collections_type&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">core_name</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;config&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;core_name&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">collections_type</span> <span class="o">==</span> <span class="s2">&quot;Core&quot;</span><span class="p">:</span>
            <span class="n">column</span> <span class="o">=</span> <span class="s2">&quot;sourceId&quot;</span>
            <span class="k">if</span> <span class="n">core_name</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;boots&quot;</span><span class="p">,</span> <span class="s2">&quot;superdrug&quot;</span><span class="p">):</span>
                <span class="n">column</span> <span class="o">=</span> <span class="s2">&quot;sku&quot;</span>
            <span class="k">if</span> <span class="n">core_name</span> <span class="o">==</span> <span class="s2">&quot;amazon&quot;</span><span class="p">:</span>
                <span class="n">column</span> <span class="o">=</span> <span class="s2">&quot;asin&quot;</span>
            <span class="n">count_query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                            SELECT</span>
<span class="s2">                            COUNT(DISTINCT CASE WHEN date = current_date THEN &quot;</span><span class="si">{</span><span class="n">column</span><span class="si">}</span><span class="s2">&quot; END) as count_today,</span>
<span class="s2">                            COUNT(DISTINCT CASE WHEN date = current_date - 1 THEN &quot;</span><span class="si">{</span><span class="n">column</span><span class="si">}</span><span class="s2">&quot; END) as count_yesterday,</span>
<span class="s2">                            ROUND(</span>
<span class="s2">                                (COUNT(DISTINCT CASE WHEN date = current_date THEN &quot;</span><span class="si">{</span><span class="n">column</span><span class="si">}</span><span class="s2">&quot; END) - COUNT(DISTINCT CASE </span>
<span class="s2">                                WHEN date = current_date - 1 THEN &quot;</span><span class="si">{</span><span class="n">column</span><span class="si">}</span><span class="s2">&quot; END)) * 100.0 / NULLIF(COUNT(DISTINCT CASE </span>
<span class="s2">                                WHEN date = current_date - 1 THEN &quot;</span><span class="si">{</span><span class="n">column</span><span class="si">}</span><span class="s2">&quot; END), 0), 0</span>
<span class="s2">                            ) as difference_percentage</span>
<span class="s2">                            FROM</span>
<span class="s2">                            </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span>
<span class="s2">                            WHERE</span>
<span class="s2">                            date IN (current_date, current_date - 1)</span>
<span class="s2">                            &quot;&quot;&quot;</span>
        <span class="k">elif</span> <span class="n">collections_type</span> <span class="o">==</span> <span class="s2">&quot;Banners&quot;</span><span class="p">:</span>
            <span class="n">count_query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                SELECT</span>
<span class="s2">                    COUNT(DISTINCT CASE WHEN date = current_date THEN &quot;apiID&quot; END) as count_today,</span>
<span class="s2">                    COUNT(DISTINCT CASE WHEN date = current_date - 1 THEN &quot;apiID&quot; END) as count_yesterday,</span>
<span class="s2">                    ROUND(</span>
<span class="s2">                        (COUNT(DISTINCT CASE WHEN date = current_date THEN &quot;apiID&quot; END) - COUNT(DISTINCT CASE </span>
<span class="s2">                        WHEN date = current_date - 1 THEN &quot;apiID&quot; END)) * 100.0 / NULLIF(COUNT(DISTINCT CASE </span>
<span class="s2">                        WHEN date = current_date - 1 THEN &quot;apiID&quot; END), 0), 0</span>
<span class="s2">                    ) as difference_percentage</span>
<span class="s2">                    FROM</span>
<span class="s2">                    banners</span>
<span class="s2">                    WHERE</span>
<span class="s2">                    date IN (current_date, current_date - 1)</span>
<span class="s2">                    AND retailer = &#39;</span><span class="si">{</span><span class="n">retailer</span><span class="si">}</span><span class="s2">&#39;</span>
<span class="s2">                    GROUP BY retailer</span>
<span class="s2">            &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Get distinct values for today, yesterday and calculated variance</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">count_query</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">distinct_count_today</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">distinct_count_yesterday</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">collected_variance</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">collected_variance</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
                <span class="n">collected_variance</span> <span class="o">=</span> <span class="s2">&quot;N/a&quot;</span>
        <span class="k">except</span> <span class="n">UniqueViolation</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">Utils</span><span class="o">.</span><span class="n">print_error</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">retailer</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="c1"># Log to DB</span>
            <span class="n">LogHandler</span><span class="o">.</span><span class="n">error_db</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
            <span class="c1"># Log to file</span>
            <span class="n">LogHandler</span><span class="o">.</span><span class="n">error_file</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>

        <span class="n">run_status</span> <span class="o">=</span> <span class="s1">&#39;Completed&#39;</span>
        <span class="n">end_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">TIMEZONE</span><span class="p">)</span>
        <span class="n">record</span> <span class="o">=</span> <span class="p">[</span><span class="n">run_status</span><span class="p">,</span> <span class="n">end_time</span><span class="p">,</span> <span class="n">data_file</span><span class="p">,</span> <span class="n">data_length</span><span class="p">,</span> <span class="n">distinct_count_today</span><span class="p">,</span> <span class="n">distinct_count_yesterday</span><span class="p">,</span>
                  <span class="n">collected_variance</span><span class="p">,</span> <span class="n">tracking_id</span><span class="p">]</span>

        <span class="n">insert_query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                    UPDATE public.collections_status </span>
<span class="s2">                    SET run_status = </span><span class="si">%s</span><span class="s2">, end_time = </span><span class="si">%s</span><span class="s2">, data_file = </span><span class="si">%s</span><span class="s2">, data_length = </span><span class="si">%s</span><span class="s2">, collected_today = </span><span class="si">%s</span><span class="s2">,</span>
<span class="s2">                    collected_yesterday = </span><span class="si">%s</span><span class="s2">, collected_variance = </span><span class="si">%s</span>
<span class="s2">                    WHERE id = </span><span class="si">%s</span>
<span class="s2">                &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">insert_query</span><span class="p">,</span> <span class="n">record</span><span class="p">)</span>
            <span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">UniqueViolation</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">Utils</span><span class="o">.</span><span class="n">print_error</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">retailer</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="c1"># Log to DB</span>
            <span class="n">LogHandler</span><span class="o">.</span><span class="n">error_db</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
            <span class="c1"># Log to file</span>
            <span class="n">LogHandler</span><span class="o">.</span><span class="n">error_file</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
            <span class="k">pass</span>

        <span class="k">if</span> <span class="n">ingest</span><span class="p">:</span>
            <span class="n">ingest_variance_query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">               SELECT ROUND(((COALESCE(today.data_length::numeric, 0) - COALESCE(yesterday.data_length::numeric,0)) / yesterday.data_length::numeric) * 100) AS variance_percentage</span>
<span class="s2">                FROM collections_status today</span>
<span class="s2">                JOIN collections_status yesterday ON today.retailer = yesterday.retailer</span>
<span class="s2">                WHERE DATE(today.date) = current_date</span>
<span class="s2">                AND today.retailer = &#39;</span><span class="si">{</span><span class="n">retailer</span><span class="si">}</span><span class="s2">&#39;</span>
<span class="s2">                AND DATE(yesterday.date) = current_date - interval &#39;1 day&#39;;</span>
<span class="s2">                &quot;&quot;&quot;</span>
            <span class="n">ingested_variance</span> <span class="o">=</span> <span class="s2">&quot;N/a&quot;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Get ingested variance</span>
                <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ingest_variance_query</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                    <span class="n">ingested_variance</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">ingested_variance</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
                        <span class="n">ingested_variance</span> <span class="o">=</span> <span class="s2">&quot;N/a&quot;</span>
            <span class="k">except</span> <span class="n">UniqueViolation</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">Utils</span><span class="o">.</span><span class="n">print_error</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">retailer</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                <span class="c1"># Log to DB</span>
                <span class="n">LogHandler</span><span class="o">.</span><span class="n">error_db</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
                <span class="c1"># Log to file</span>
                <span class="n">LogHandler</span><span class="o">.</span><span class="n">error_file</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>

            <span class="c1"># Update record with calculated ingest variance</span>
            <span class="n">ingest_variance_insert_query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                            UPDATE public.collections_status </span>
<span class="s2">                            SET ingested_variance = </span><span class="si">%s</span>
<span class="s2">                            WHERE id = </span><span class="si">%s</span>
<span class="s2">                            &quot;&quot;&quot;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="n">ingested_variance</span><span class="p">,</span> <span class="n">tracking_id</span><span class="p">]</span>
                <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ingest_variance_insert_query</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
                <span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">UniqueViolation</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">Utils</span><span class="o">.</span><span class="n">print_error</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">retailer</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                <span class="c1"># Log to DB</span>
                <span class="n">LogHandler</span><span class="o">.</span><span class="n">error_db</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
                <span class="c1"># Log to file</span>
                <span class="n">LogHandler</span><span class="o">.</span><span class="n">error_file</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
                <span class="k">pass</span>

        <span class="n">Utils</span><span class="o">.</span><span class="n">print_debug</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">retailer</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">retailer</span><span class="si">}</span><span class="s2"> completed!&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Utils.set_failed">
<a class="viewcode-back" href="../../tools.html#tools.utils.Utils.set_failed">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">set_failed</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">tracking_id</span><span class="p">,</span> <span class="n">from_scraper_validate</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the status of a failed data collection process in the database and create a task if not in debug mode.</span>

<span class="sd">        - Retrieves the collection type from the database using `tracking_id`.</span>
<span class="sd">        - Updates the `run_status` and `end_time` in the `collections_status` table.</span>
<span class="sd">        - Logs errors to the database and file using `LogHandler` in case of exceptions.</span>
<span class="sd">        - If not in debug mode (`DEBUG=1`), creates a ClickUp task based on the failure scenario.</span>

<span class="sd">        :param retailer: The name or identifier of the retailer for which the collection status is being updated.</span>
<span class="sd">        :param tracking_id: The ID of the collection process status record to update.</span>
<span class="sd">        :param from_scraper_validate: Flag indicating if the failure occurred during scraper validation.</span>
<span class="sd">            Defaults to False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">datetime</span>
        <span class="n">debug</span> <span class="o">=</span> <span class="n">Utils</span><span class="o">.</span><span class="n">setup_debugging</span><span class="p">()</span>
        <span class="n">connection</span> <span class="o">=</span> <span class="n">Utils</span><span class="o">.</span><span class="n">create_db_con</span><span class="p">()</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="n">run_status</span> <span class="o">=</span> <span class="s1">&#39;Failed&#39;</span>
        <span class="n">end_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">TIMEZONE</span><span class="p">)</span>
        <span class="n">record</span> <span class="o">=</span> <span class="p">[</span><span class="n">run_status</span><span class="p">,</span> <span class="n">end_time</span><span class="p">,</span> <span class="n">tracking_id</span><span class="p">]</span>

        <span class="n">insert_query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                        UPDATE public.collections_status </span>
<span class="s2">                        SET run_status = </span><span class="si">%s</span><span class="s2">, end_time = </span><span class="si">%s</span>
<span class="s2">                        WHERE id = </span><span class="si">%s</span><span class="s2">;</span>
<span class="s2">                    &quot;&quot;&quot;</span>
        <span class="n">collection_type_query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;SELECT type FROM public.collections_status WHERE id = </span><span class="si">{</span><span class="n">tracking_id</span><span class="si">}</span><span class="s2">;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">insert_query</span><span class="p">,</span> <span class="n">record</span><span class="p">)</span>
            <span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

            <span class="c1"># Get collection type.</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">collection_type_query</span><span class="p">)</span>
            <span class="n">collection_type</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">COLLECTION_TYPE</span><span class="p">[</span><span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]]</span>

            <span class="c1"># Create ClickUp Task</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">DEBUG</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">from_scraper_validate</span><span class="p">:</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Non-ingested collection failed, please investigate&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Collection failed, please investigate ASAP!&quot;</span>
                <span class="n">Utils</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">collection_type</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">UniqueViolation</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">Utils</span><span class="o">.</span><span class="n">print_error</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">retailer</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="c1"># Log to DB</span>
            <span class="n">LogHandler</span><span class="o">.</span><span class="n">error_db</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
            <span class="c1"># Log to file</span>
            <span class="n">LogHandler</span><span class="o">.</span><span class="n">error_file</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
            <span class="k">pass</span></div>


<div class="viewcode-block" id="Utils.get_insert_query">
<a class="viewcode-back" href="../../tools.html#tools.utils.Utils.get_insert_query">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_insert_query</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">table_columns</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate an SQL INSERT statement for a given table with specified columns.</span>

<span class="sd">        :param table_name: The name of the table into which data is to be inserted.</span>
<span class="sd">        :param table_columns: List of column names to insert data into.</span>
<span class="sd">        :return: The generated SQL INSERT statement.</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">columns_part</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="n">col</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">table_columns</span><span class="p">])</span>
        <span class="n">placeholders</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">table_columns</span><span class="p">])</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;INSERT INTO </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">columns_part</span><span class="si">}</span><span class="s2">) VALUES (</span><span class="si">{</span><span class="n">placeholders</span><span class="si">}</span><span class="s2">);&quot;</span></div>


<div class="viewcode-block" id="Utils.validate_data">
<a class="viewcode-back" href="../../tools.html#tools.utils.Utils.validate_data">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">validate_data</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">source_id</span><span class="p">,</span> <span class="n">shelf_price</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validate product data attributes to ensure they are not empty or null.</span>

<span class="sd">        This function checks if the provided `title`, `source_id`, and `shelf_price`</span>
<span class="sd">        are not None or any of the following: &quot;0&quot;, &quot;0.0&quot;, &quot;0.00&quot;, &quot;&quot; (empty string).</span>

<span class="sd">        :param title: The product title.</span>
<span class="sd">        :param source_id: The product ID or source identifier.</span>
<span class="sd">        :param shelf_price: The product price as a string.</span>
<span class="sd">        :return: True if all attributes are valid (not None or empty/invalid values),</span>
<span class="sd">            False otherwise.</span>
<span class="sd">        :rtype: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> \
            <span class="ow">and</span> <span class="n">source_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> \
            <span class="ow">and</span> <span class="n">shelf_price</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="s2">&quot;0.0&quot;</span><span class="p">,</span> <span class="s2">&quot;0.00&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Utils.get_field_id">
<a class="viewcode-back" href="../../tools.html#tools.utils.Utils.get_field_id">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_field_id</span><span class="p">(</span><span class="n">field_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve the ID of a specific field by its name from a ClickUp list.</span>

<span class="sd">        This function makes a GET request to the ClickUp API endpoint to fetch</span>
<span class="sd">        the fields of a specified list. It then searches for a field with a matching</span>
<span class="sd">        name and returns its ID if found.</span>

<span class="sd">        :param: field_name: The name of the field to retrieve the ID for.</span>
<span class="sd">        :return: The ID of the field if found, None if not found or if there&#39;s</span>
<span class="sd">                  an error during the API request.</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://api.clickup.com/api/v2/list/&quot;</span> <span class="o">+</span> <span class="n">CLICKUP_LIST_ID</span> <span class="o">+</span> <span class="s2">&quot;/field&quot;</span>

        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">CLICKUP_HEADERS</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">r</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;fields&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">field</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">field_name</span><span class="p">:</span>
                    <span class="n">field_id</span> <span class="o">=</span> <span class="n">field</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">field_id</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">field_id</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Utils.set_new_task_category">
<a class="viewcode-back" href="../../tools.html#tools.utils.Utils.set_new_task_category">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">set_new_task_category</span><span class="p">(</span><span class="n">task_id</span><span class="p">,</span> <span class="n">bug_id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update a ClickUp task with a bug ID in a specific custom field.</span>

<span class="sd">        This function updates a ClickUp task identified by `task_id` with a bug ID in a custom field named &quot;Category&quot;.</span>
<span class="sd">        It uses the ClickUp API to perform the update.</span>

<span class="sd">        :param task_id: The ID of the ClickUp task to update.</span>
<span class="sd">        :param bug_id: The bug ID to set in the custom field.</span>
<span class="sd">        :return: True if the task was successfully updated, False otherwise.</span>
<span class="sd">        :rtype: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">field_id</span> <span class="o">=</span> <span class="n">Utils</span><span class="o">.</span><span class="n">get_field_id</span><span class="p">(</span><span class="s2">&quot;Category&quot;</span><span class="p">)</span>
            <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://api.clickup.com/api/v2/task/&quot;</span> <span class="o">+</span> <span class="n">task_id</span> <span class="o">+</span> <span class="s2">&quot;/field/&quot;</span> <span class="o">+</span> <span class="n">field_id</span>
            <span class="n">query</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;custom_task_ids&quot;</span><span class="p">:</span> <span class="s2">&quot;false&quot;</span><span class="p">,</span>
            <span class="p">}</span>

            <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">bug_id</span><span class="p">]</span>
            <span class="p">}</span>

            <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">CLICKUP_HEADERS</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">query</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">r</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Log to DB</span>
            <span class="n">LogHandler</span><span class="o">.</span><span class="n">error_db</span><span class="p">(</span><span class="s2">&quot;Clickup API&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span></div>


<div class="viewcode-block" id="Utils.create_task">
<a class="viewcode-back" href="../../tools.html#tools.utils.Utils.create_task">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">create_task</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">collection_type</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update a ClickUp task with a bug ID in a specific custom field.</span>

<span class="sd">        This function updates a ClickUp task identified by `task_id` with a bug ID</span>
<span class="sd">        in a custom field named &quot;Category&quot;. It uses the ClickUp API to perform the update.</span>

<span class="sd">        :param retailer: The retailer name.</span>
<span class="sd">        :param description: Task description which we want to add.</span>
<span class="sd">        :param collection_type: The issue the ticket is being logged for.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">create_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://api.clickup.com/api/v2/list/</span><span class="si">{</span><span class="n">CLICKUP_LIST_ID</span><span class="si">}</span><span class="s2">/task&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;custom_task_ids&quot;</span><span class="p">:</span> <span class="s2">&quot;false&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">retailer</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">collection_type</span><span class="si">}</span><span class="s2"> Issue - </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">description</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">create_url</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">CLICKUP_HEADERS</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">query</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">r</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
                    <span class="n">task_id</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;custom_fields&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;type_config&#39;</span><span class="p">][</span><span class="s1">&#39;options&#39;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">option</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Bug&#39;</span><span class="p">:</span>
                            <span class="n">bug_id</span> <span class="o">=</span> <span class="n">option</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>

                    <span class="c1"># Update the new task category to bug</span>
                    <span class="n">Utils</span><span class="o">.</span><span class="n">set_new_task_category</span><span class="p">(</span><span class="n">task_id</span><span class="p">,</span> <span class="n">bug_id</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Log to DB</span>
            <span class="n">LogHandler</span><span class="o">.</span><span class="n">error_db</span><span class="p">(</span><span class="s2">&quot;Clickup API&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span></div>


<div class="viewcode-block" id="Utils.format_price">
<a class="viewcode-back" href="../../tools.html#tools.utils.Utils.format_price">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">format_price</span><span class="p">(</span><span class="n">price</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clean and format a price string by removing unwanted characters and ensuring it has two decimal places.</span>

<span class="sd">        This function cleans up the provided `price` string by removing specific characters such as currency symbols,</span>
<span class="sd">        commas, newline characters, and price units (e.g., &#39;/kg&#39;, &#39;avg/ea&#39;). It also ensures that the price always has</span>
<span class="sd">        two decimal places.</span>

<span class="sd">        :param price: The price string to clean and format.</span>
<span class="sd">        :return: The cleaned and formatted price string with two decimal places.</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">price</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">price</span>

        <span class="n">replacements</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;,&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;€&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot; €&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;$&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;£&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;/kg&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot; avg/ea&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>
        <span class="p">}</span>

        <span class="n">price</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">price</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">old_value</span><span class="p">,</span> <span class="n">new_value</span> <span class="ow">in</span> <span class="n">replacements</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">price</span> <span class="o">=</span> <span class="n">price</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">old_value</span><span class="p">,</span> <span class="n">new_value</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;.&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">price</span><span class="p">:</span>
            <span class="c1"># If there&#39;s no decimal point, add &#39;.00&#39; to the end of the price</span>
            <span class="n">price</span> <span class="o">=</span> <span class="n">price</span> <span class="o">+</span> <span class="s1">&#39;.00&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If there&#39;s a decimal point, ensure there are two decimal places</span>
            <span class="n">price</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">price</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">price</span></div>


<div class="viewcode-block" id="Utils.bn_api_auth">
<a class="viewcode-back" href="../../tools.html#tools.utils.Utils.bn_api_auth">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">bn_api_auth</span><span class="p">(</span><span class="n">retailer</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Authenticate with the admin API using username and password, and retrieve the authentication token.</span>

<span class="sd">        This function sends a POST request to the specified `BN_AUTH_URL` endpoint with the provided `ADMIN_API_USER`</span>
<span class="sd">        and `ADMIN_API_PASS` credentials as JSON payload. If authentication is successful (status code 200), it logs</span>
<span class="sd">        the successful authentication time and returns the authentication token from the response JSON. If</span>
<span class="sd">        authentication fails, it logs an error and returns None.</span>

<span class="sd">        :param retailer: The current retailer.</span>
<span class="sd">        :return: The authentication token if authentication is successful, otherwise None.</span>
<span class="sd">        :rtype: str or none</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">debug</span> <span class="o">=</span> <span class="n">Utils</span><span class="o">.</span><span class="n">setup_debugging</span><span class="p">()</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="n">ADMIN_API_USER</span><span class="p">,</span>
            <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="n">ADMIN_API_PASS</span>
        <span class="p">}</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">Utils</span><span class="o">.</span><span class="n">make_request_post</span><span class="p">(</span><span class="n">BN_AUTH_URL</span><span class="p">,</span> <span class="n">BN_AUTH_HEADERS</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">r</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="n">Utils</span><span class="o">.</span><span class="n">print_debug</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">retailer</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Auth request successful in </span><span class="si">{</span><span class="n">r</span><span class="o">.</span><span class="n">elapsed</span><span class="o">.</span><span class="n">seconds</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;token&#39;</span><span class="p">]</span>
        <span class="n">Utils</span><span class="o">.</span><span class="n">print_error</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">retailer</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Authentication failed&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Utils.get_bn_api_data">
<a class="viewcode-back" href="../../tools.html#tools.utils.Utils.get_bn_api_data">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_bn_api_data</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">core_name</span><span class="p">,</span> <span class="n">collections_type</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Authenticate and fetch API data from BrandNudge API.</span>

<span class="sd">        This function performs authentication using `Utils.bn_api_auth(retailer)` for authorization headers,</span>
<span class="sd">        constructs necessary headers and parameters for the API request, and fetches data from `BN_API_URL`.</span>
<span class="sd">        It handles exceptions, logs errors to DB and file using `LogHandler`, and returns fetched data if successful.</span>

<span class="sd">        :param retailer: The current retailer name.</span>
<span class="sd">        :param core_name: The core name of the retailer.</span>
<span class="sd">        :param collections_type: The type of collections (e.g., &#39;Core&#39;, &#39;Banners&#39;).</span>
<span class="sd">        :return: The API response data as a dictionary if successful, otherwise None.</span>
<span class="sd">        :rtype: dict or none</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">debug</span> <span class="o">=</span> <span class="n">Utils</span><span class="o">.</span><span class="n">setup_debugging</span><span class="p">()</span>
            <span class="n">Utils</span><span class="o">.</span><span class="n">print_debug</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">retailer</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Authenticating&quot;</span><span class="p">)</span>
            <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;authority&#39;</span><span class="p">:</span> <span class="s1">&#39;api2.brandnudge-platform.com&#39;</span><span class="p">,</span>
                <span class="s1">&#39;accept&#39;</span><span class="p">:</span> <span class="s1">&#39;application/json, text/plain, */*&#39;</span><span class="p">,</span>
                <span class="s1">&#39;accept-language&#39;</span><span class="p">:</span> <span class="s1">&#39;en-GB,en-US;q=0.9,en;q=0.8&#39;</span><span class="p">,</span>
                <span class="s1">&#39;authorization&#39;</span><span class="p">:</span> <span class="n">Utils</span><span class="o">.</span><span class="n">bn_api_auth</span><span class="p">(</span><span class="n">retailer</span><span class="p">),</span>
            <span class="p">}</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;retailer&quot;</span><span class="p">:</span> <span class="n">core_name</span><span class="p">,</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">collections_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="p">}</span>
            <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">BN_API_URL</span><span class="si">}</span><span class="s2">?</span><span class="si">{</span><span class="n">urlencode</span><span class="p">(</span><span class="n">params</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">Utils</span><span class="o">.</span><span class="n">make_request_post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">retailer</span><span class="p">,</span> <span class="n">payload</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">r</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                <span class="n">Utils</span><span class="o">.</span><span class="n">print_debug</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">retailer</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;API data found and returned&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">data</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">Utils</span><span class="o">.</span><span class="n">print_error</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">retailer</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="c1"># Log to DB</span>
            <span class="n">LogHandler</span><span class="o">.</span><span class="n">error_db</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
            <span class="c1"># Log to file</span>
            <span class="n">LogHandler</span><span class="o">.</span><span class="n">error_file</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span></div>


<div class="viewcode-block" id="Utils.validate_images">
<a class="viewcode-back" href="../../tools.html#tools.utils.Utils.validate_images">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">validate_images</span><span class="p">(</span><span class="n">headers</span><span class="p">,</span> <span class="n">retailer</span><span class="p">,</span> <span class="n">banner_url</span><span class="p">,</span> <span class="n">screenshot_url</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if the provided URLs for banner and screenshot images are valid.</span>

<span class="sd">        If DEBUG is True, returns True immediately assuming images won&#39;t be uploaded.</span>
<span class="sd">        Otherwise, makes HTTP GET requests to verify each URL&#39;s validity using `Utils.make_request`.</span>
<span class="sd">        Returns True if all URLs return a 200 status code, False otherwise.</span>

<span class="sd">        :param headers: Headers to be used in the HTTP requests.</span>
<span class="sd">        :param retailer: Name of the retailer for debugging and logging purposes.</span>
<span class="sd">        :param banner_url: URL of the banner image.</span>
<span class="sd">        :param screenshot_url: URL of the screenshot image.</span>
<span class="sd">        :return: True if all URLs are valid (return 200 status), False otherwise.</span>
<span class="sd">        :rtype: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
            <span class="c1"># Images will not be uploaded so just returning True</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">def</span> <span class="nf">is_url_valid</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">url</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">Utils</span><span class="o">.</span><span class="n">make_request</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">retailer</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">r</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">valid</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span><span class="n">is_url_valid</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="p">[</span><span class="n">banner_url</span><span class="p">,</span> <span class="n">screenshot_url</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">valid</span></div>


<div class="viewcode-block" id="Utils.update_progress">
<a class="viewcode-back" href="../../tools.html#tools.utils.Utils.update_progress">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">update_progress</span><span class="p">(</span><span class="n">total_count</span><span class="p">,</span> <span class="n">current</span><span class="p">,</span> <span class="n">tracking_id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the &#39;public.collections_status&#39; table with the provided total_count,</span>
<span class="sd">        current progress, and tracking_id.</span>

<span class="sd">        :param total_count: Total count to be updated.</span>
<span class="sd">        :param current: Current progress to be updated.</span>
<span class="sd">        :param tracking_id: ID of the record to update.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">connection</span> <span class="o">=</span> <span class="n">Utils</span><span class="o">.</span><span class="n">create_db_con</span><span class="p">()</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="n">record</span> <span class="o">=</span> <span class="p">[</span><span class="n">total_count</span><span class="p">,</span> <span class="n">current</span><span class="p">,</span> <span class="n">tracking_id</span><span class="p">]</span>

        <span class="n">insert_query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                        UPDATE public.collections_status </span>
<span class="s2">                        SET urls = </span><span class="si">%s</span><span class="s2">, progress = </span><span class="si">%s</span>
<span class="s2">                        WHERE id = </span><span class="si">%s</span><span class="s2">;</span>
<span class="s2">                        &quot;&quot;&quot;</span>

        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">insert_query</span><span class="p">,</span> <span class="n">record</span><span class="p">)</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>


<div class="viewcode-block" id="Utils.redact_api_key">
<a class="viewcode-back" href="../../tools.html#tools.utils.Utils.redact_api_key">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">redact_api_key</span><span class="p">(</span><span class="n">message</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Redacts API keys from a given message by replacing them with &#39;API_KEY_REDACTED&#39;.</span>

<span class="sd">        :param message: The message containing API keys.</span>
<span class="sd">        :return: The message with API keys redacted or the original message if redaction fails.</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">api_key_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&amp;apikey=[a-zA-Z0-9]+&quot;</span>
            <span class="n">message</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">api_key_pattern</span><span class="p">,</span> <span class="s2">&quot;&amp;apikey=API_KEY_REDACTED&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">message</span><span class="p">)))</span>
            <span class="k">return</span> <span class="n">message</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">message</span></div>


<div class="viewcode-block" id="Utils.get_country_info">
<a class="viewcode-back" href="../../tools.html#tools.utils.Utils.get_country_info">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_country_info</span><span class="p">(</span><span class="n">country_code</span><span class="p">,</span> <span class="n">retailer</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve country information from the database based on the country code.</span>

<span class="sd">        :param country_code: The country code to query in the database.</span>
<span class="sd">        :param retailer: The retailer name</span>
<span class="sd">        :return: Dictionary containing country information (if found).</span>
<span class="sd">            Keys: &quot;countryName&quot;, &quot;countryCode&quot;, &quot;alpha2Code&quot;, &quot;currency&quot;, &quot;currencySymbol&quot;, &quot;proxyPort&quot;</span>
<span class="sd">        :rtype: list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">debug</span> <span class="o">=</span> <span class="n">Utils</span><span class="o">.</span><span class="n">setup_debugging</span><span class="p">()</span>
            <span class="n">connection</span> <span class="o">=</span> <span class="n">Utils</span><span class="o">.</span><span class="n">create_db_con</span><span class="p">()</span>
            <span class="n">country_query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                SELECT</span>
<span class="s2">                    &quot;countryName&quot;, &quot;countryCode&quot;, &quot;alpha2Code&quot;, currency, &quot;currencySymbol&quot;, &quot;proxyPort&quot;</span>
<span class="s2">                FROM</span>
<span class="s2">                public.countryInfo</span>
<span class="s2">                WHERE &quot;countryCode&quot; = %s;</span>
<span class="s2">            &quot;&quot;&quot;</span>

            <span class="c1"># Get country info.</span>
            <span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">(</span><span class="n">cursor_factory</span><span class="o">=</span><span class="n">psycopg2</span><span class="o">.</span><span class="n">extras</span><span class="o">.</span><span class="n">RealDictCursor</span><span class="p">)</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">country_query</span><span class="p">,</span> <span class="p">(</span><span class="n">country_code</span><span class="p">,))</span>
            <span class="k">if</span> <span class="n">cursor</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Country info not found, check if the country have been added to the countryInfo table&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">Utils</span><span class="o">.</span><span class="n">print_error</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">retailer</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="c1"># Log to DB</span>
            <span class="n">LogHandler</span><span class="o">.</span><span class="n">error_db</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
            <span class="c1"># Log to file</span>
            <span class="n">LogHandler</span><span class="o">.</span><span class="n">error_file</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span></div>
</div>



<div class="viewcode-block" id="Ingest">
<a class="viewcode-back" href="../../tools.html#tools.utils.Ingest">[docs]</a>
<span class="k">class</span> <span class="nc">Ingest</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class for extracting data from a retailer&#39;s database, subjecting it to a comprehensive set of validation rules,</span>
<span class="sd">    and finally uploading it to an AWS S3 bucket.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">datetime</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s3</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span>
            <span class="s1">&#39;s3&#39;</span><span class="p">,</span>
            <span class="n">region_name</span><span class="o">=</span><span class="n">AWS_REGION</span><span class="p">,</span>
            <span class="n">aws_access_key_id</span><span class="o">=</span><span class="n">AWS_INGEST_ACCESS_KEY_ID</span><span class="p">,</span>
            <span class="n">aws_secret_access_key</span><span class="o">=</span><span class="n">AWS_INGEST_SECRET_ACCESS_KEY</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="n">Utils</span><span class="o">.</span><span class="n">create_db_con</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">Utils</span><span class="o">.</span><span class="n">setup_debugging</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">today_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span>

<div class="viewcode-block" id="Ingest.extract_data_from_db">
<a class="viewcode-back" href="../../tools.html#tools.utils.Ingest.extract_data_from_db">[docs]</a>
    <span class="k">def</span> <span class="nf">extract_data_from_db</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retailer</span><span class="p">,</span> <span class="n">extract_query</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract product data from retailers table.</span>

<span class="sd">        This method executes the provided SQL query to extract data from the retailer&#39;s table.</span>
<span class="sd">        If the `params` argument is True, the query is executed with the current date as a parameter.</span>
<span class="sd">        After executing the query, the method checks if any rows are fetched. If rows are found, it prints a debug</span>
<span class="sd">        message and returns the fetched data. If no rows are found, it returns None.</span>

<span class="sd">        :param retailer: Current retailer.</span>
<span class="sd">        :param extract_query: SQL query to extract product data specific to the retailer.</span>
<span class="sd">        :param params: Indicates whether parameters are passed into the query. Defaults to True.</span>
<span class="sd">        :return: Extracted data from the database.</span>
<span class="sd">        :rtype: list of tuples or None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">params</span><span class="p">:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">extract_query</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">today_date</span><span class="p">,))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">extract_query</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cursor</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">Utils</span><span class="o">.</span><span class="n">print_debug</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">,</span> <span class="n">retailer</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Data extracted for </span><span class="si">{</span><span class="n">retailer</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">cursor</span><span class="o">.</span><span class="n">rowcount</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Ingest.is_valid_url">
<a class="viewcode-back" href="../../tools.html#tools.utils.Ingest.is_valid_url">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">is_valid_url</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validate whether the given URL is well-formed and valid</span>

<span class="sd">        This method uses the `urlparse` function from the `urllib.parse` module to parse the URL.</span>
<span class="sd">        It checks if the URL has a scheme and a network location. If both are present, the URL is considered valid.</span>
<span class="sd">        If the URL is malformed, a ValueError is caught, and the method returns False.</span>

<span class="sd">        :param url: The URL to be validated.</span>
<span class="sd">        :return: True if the URL is valid, False otherwise.</span>
<span class="sd">        :rtype: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">all</span><span class="p">([</span><span class="n">result</span><span class="o">.</span><span class="n">scheme</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">netloc</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="Ingest.validate_data">
<a class="viewcode-back" href="../../tools.html#tools.utils.Ingest.validate_data">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">validate_data</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validate the given data against defined criteria.</span>

<span class="sd">        This method validates the given data against a set of predefined criteria.</span>
<span class="sd">        It checks for the presence of required keys, verifies the format of prices,</span>
<span class="sd">        ensures consistency between prices and promotion details, validates URLs,</span>
<span class="sd">        and checks for other specific constraints.</span>

<span class="sd">        :param data: Data to be validated.</span>
<span class="sd">        :return: A tuple containing a boolean indicating if the data is valid and a string</span>
<span class="sd">            describing the validation result.</span>
<span class="sd">        :rtype: tuple(bool, str)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">expected_keys</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;sourceId&quot;</span><span class="p">,</span> <span class="s2">&quot;ean&quot;</span><span class="p">,</span> <span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;shelfPrice&quot;</span><span class="p">,</span> <span class="s2">&quot;wasPrice&quot;</span><span class="p">,</span> <span class="s2">&quot;cardPrice&quot;</span><span class="p">,</span>
                         <span class="s2">&quot;inStock&quot;</span><span class="p">,</span> <span class="s2">&quot;onPromo&quot;</span><span class="p">,</span> <span class="s2">&quot;skuURL&quot;</span><span class="p">,</span> <span class="s2">&quot;imageURL&quot;</span><span class="p">)</span>
        <span class="n">expected_bools</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;inStock&quot;</span><span class="p">,</span> <span class="s2">&quot;onPromo&quot;</span><span class="p">)</span>
        <span class="n">expected_urls</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;skuURL&quot;</span><span class="p">,</span> <span class="s2">&quot;imageURL&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;retailer&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Retailer field is missing&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;products&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Products list is empty&quot;</span>

        <span class="k">for</span> <span class="n">product</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;products&quot;</span><span class="p">]:</span>
            <span class="n">product_errors</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">expected_key</span> <span class="ow">in</span> <span class="n">expected_keys</span><span class="p">:</span>
                <span class="c1"># Missing keys.</span>
                <span class="k">if</span> <span class="n">expected_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">product</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">product_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;no </span><span class="si">{</span><span class="n">expected_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="c1"># URLs are valid.</span>
                <span class="k">if</span> <span class="n">expected_key</span> <span class="ow">in</span> <span class="n">expected_urls</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">Ingest</span><span class="o">.</span><span class="n">is_valid_url</span><span class="p">(</span><span class="n">product</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">expected_key</span><span class="p">)):</span>
                    <span class="n">product_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">expected_key</span><span class="si">}</span><span class="s2"> bad url&quot;</span><span class="p">)</span>
                <span class="c1"># Wrong type.</span>
                <span class="k">elif</span> <span class="n">expected_key</span> <span class="ow">in</span> <span class="n">expected_bools</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">product</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">expected_key</span><span class="p">),</span> <span class="nb">bool</span><span class="p">):</span>
                    <span class="n">product_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">expected_key</span><span class="si">}</span><span class="s2"> not bool&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">product_errors</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Invalid product data for </span><span class="si">{</span><span class="n">product</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">, ERRORS: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">product_errors</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^\d+\.\d</span><span class="si">{2}</span><span class="s2">$&quot;</span><span class="p">,</span> <span class="n">product</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;shelfPrice&quot;</span><span class="p">)):</span>
                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Shelf price is not a valid float with 2 decimals for </span><span class="si">{</span><span class="n">product</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^\d+\.\d</span><span class="si">{2}</span><span class="s2">$&quot;</span><span class="p">,</span> <span class="n">product</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;wasPrice&quot;</span><span class="p">)):</span>
                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Was price is not a valid float with 2 decimals for </span><span class="si">{</span><span class="n">product</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^\d+\.\d</span><span class="si">{2}</span><span class="s2">$&quot;</span><span class="p">,</span> <span class="n">product</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cardPrice&quot;</span><span class="p">)):</span>
                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Card price is not a valid float with 2 decimals for </span><span class="si">{</span><span class="n">product</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="k">if</span> <span class="n">product</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;onPromo&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">product</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;promoData&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Promo details is not a valid for </span><span class="si">{</span><span class="n">product</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">product</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;onPromo&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">product</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;promoData&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Promo details is not a valid for </span><span class="si">{</span><span class="n">product</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="c1"># Was price less than shelf price</span>
            <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">product</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;wasPrice&quot;</span><span class="p">))</span> <span class="o">&lt;</span> <span class="nb">float</span><span class="p">(</span><span class="n">product</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;shelfPrice&quot;</span><span class="p">)):</span>
                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Was price should not be less than shelf price for </span><span class="si">{</span><span class="n">product</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="c1"># Shelf price should be equal to card price</span>
            <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">product</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;shelfPrice&quot;</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">float</span><span class="p">(</span><span class="n">product</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cardPrice&quot;</span><span class="p">)):</span>
                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Card price should not be different than shelf price for </span><span class="si">{</span><span class="n">product</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="c1"># EAN should never be None or empty</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">product</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ean&quot;</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;EAN should not be None or empty for </span><span class="si">{</span><span class="n">product</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;Data is valid&quot;</span></div>


<div class="viewcode-block" id="Ingest.generate_export_file">
<a class="viewcode-back" href="../../tools.html#tools.utils.Ingest.generate_export_file">[docs]</a>
    <span class="k">def</span> <span class="nf">generate_export_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retailer</span><span class="p">,</span> <span class="n">promo_data_applied</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Processes and saves product data for a retailer.</span>

<span class="sd">        This method validates the given product data and saves it to a JSON file.</span>
<span class="sd">        If any validation errors occur, they are logged, and an exception is raised.</span>
<span class="sd">        The promotional product data is then saved to a JSON file with a filename based on the retailer&#39;s name</span>
<span class="sd">        and the current date.</span>

<span class="sd">        :param retailer: The name of the retailer.</span>
<span class="sd">        :param promo_data_applied: Promotional product data applied.</span>
<span class="sd">        :return: The filename of the saved JSON file.</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">valid</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="n">Ingest</span><span class="o">.</span><span class="n">validate_data</span><span class="p">(</span><span class="n">promo_data_applied</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">valid</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">Utils</span><span class="o">.</span><span class="n">print_error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">,</span> <span class="n">retailer</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="c1"># Log to DB</span>
            <span class="n">LogHandler</span><span class="o">.</span><span class="n">error_db</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
            <span class="c1"># Log to file</span>
            <span class="n">LogHandler</span><span class="o">.</span><span class="n">error_file</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>

        <span class="n">retailer</span> <span class="o">=</span> <span class="n">retailer</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&amp;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">product_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">promo_data_applied</span><span class="p">)</span>
        <span class="n">data_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;products_pp-</span><span class="si">{</span><span class="n">retailer</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">today_date</span><span class="si">}</span><span class="s2">.json&quot;</span>
        <span class="n">Utils</span><span class="o">.</span><span class="n">print_debug</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">,</span> <span class="n">retailer</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Data filename: </span><span class="si">{</span><span class="n">data_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">data_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">product_data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data_file</span></div>


<div class="viewcode-block" id="Ingest.generate_export_banner_file">
<a class="viewcode-back" href="../../tools.html#tools.utils.Ingest.generate_export_banner_file">[docs]</a>
    <span class="k">def</span> <span class="nf">generate_export_banner_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retailer</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Saves banner data for a retailer to a JSON file.</span>

<span class="sd">        This method converts the banner data into JSON format and saves it to a JSON file.</span>
<span class="sd">        The filename of the JSON file is constructed using the retailer&#39;s name and the current date.</span>
<span class="sd">        The saved JSON file contains the banner data for the retailer.</span>

<span class="sd">        :param retailer: The name of the retailer.</span>
<span class="sd">        :param data: The banner data to be saved.</span>
<span class="sd">        :return: The filename of the saved JSON file.</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">data_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;banners-</span><span class="si">{</span><span class="n">retailer</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">today_date</span><span class="si">}</span><span class="s2">.json&quot;</span>
        <span class="n">Utils</span><span class="o">.</span><span class="n">print_debug</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">,</span> <span class="n">retailer</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Data filename: </span><span class="si">{</span><span class="n">data_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">data_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data_file</span></div>


<div class="viewcode-block" id="Ingest.upload_file_to_s3">
<a class="viewcode-back" href="../../tools.html#tools.utils.Ingest.upload_file_to_s3">[docs]</a>
    <span class="k">def</span> <span class="nf">upload_file_to_s3</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retailer</span><span class="p">,</span> <span class="n">data_file</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Uploads a file to an AWS S3 bucket.</span>

<span class="sd">        This method uploads a file to an AWS S3 bucket.</span>
<span class="sd">        If the debug mode is disabled, the file is uploaded to the designated S3 bucket.</span>
<span class="sd">        The filename used for the S3 object is prefixed with &#39;Ready/&#39;.</span>
<span class="sd">        Upon successful upload, a debug message is printed indicating the filename uploaded to S3.</span>
<span class="sd">        Returns True if the upload is successful, otherwise returns False.</span>

<span class="sd">        :param data_file: The filename of the file to be uploaded.</span>
<span class="sd">        :param retailer: The name of the retailer.</span>
<span class="sd">        :return: True if the upload is successful, False otherwise.</span>
<span class="sd">        :rtype: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">DEBUG</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">s3</span><span class="o">.</span><span class="n">Bucket</span><span class="p">(</span><span class="n">AWS_INGEST_BUCKET</span><span class="p">)</span><span class="o">.</span><span class="n">put_object</span><span class="p">(</span>
                <span class="n">Key</span><span class="o">=</span><span class="s1">&#39;Ready/&#39;</span> <span class="o">+</span> <span class="n">data_file</span><span class="p">,</span>
                <span class="n">Body</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="n">data_file</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">Utils</span><span class="o">.</span><span class="n">print_debug</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">,</span> <span class="n">retailer</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Filename: </span><span class="si">{</span><span class="n">data_file</span><span class="si">}</span><span class="s2"> uploaded to S3&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="Ingest.delete_local_file">
<a class="viewcode-back" href="../../tools.html#tools.utils.Ingest.delete_local_file">[docs]</a>
    <span class="k">def</span> <span class="nf">delete_local_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retailer</span><span class="p">,</span> <span class="n">data_file</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deletes a local file.</span>

<span class="sd">        This method attempts to delete a local file.</span>
<span class="sd">        If the debug mode is disabled, and the file exists, it is deleted.</span>
<span class="sd">        If the file does not exist, a debug message is printed indicating the filename was not found.</span>
<span class="sd">        If an exception occurs during the deletion process, it is caught, and a debug message is printed.</span>

<span class="sd">        :param retailer: The name of the retailer.</span>
<span class="sd">        :param data_file: The filename of the file to be deleted.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">DEBUG</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">data_file</span><span class="p">)</span>
                <span class="n">Utils</span><span class="o">.</span><span class="n">print_debug</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">,</span> <span class="n">retailer</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Filename: </span><span class="si">{</span><span class="n">data_file</span><span class="si">}</span><span class="s2"> deleted&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                <span class="n">Utils</span><span class="o">.</span><span class="n">print_error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">,</span> <span class="n">retailer</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Filename: </span><span class="si">{</span><span class="n">data_file</span><span class="si">}</span><span class="s2"> not found&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">Utils</span><span class="o">.</span><span class="n">print_debug</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">,</span> <span class="n">retailer</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span></div>


<div class="viewcode-block" id="Ingest.main">
<a class="viewcode-back" href="../../tools.html#tools.utils.Ingest.main">[docs]</a>
    <span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retailer</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">delay</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract, prepare and upload data to a S3 bucket. Move the file to processed</span>

<span class="sd">        This method processes data for a specific retailer. It checks if the retailer&#39;s name matches the one in the data</span>
<span class="sd">        and if the data contains products. If both conditions are met, it generates an export file, waits for the</span>
<span class="sd">        specified delay, and then uploads the file to an S3 bucket. If the upload is successful, the local file is</span>
<span class="sd">        deleted. If any validation or processing errors occur, they are logged and raised.</span>

<span class="sd">        :param retailer: The name of the retailer.</span>
<span class="sd">        :param data: The data to be processed. In this case, product data.</span>
<span class="sd">        :param delay: The delay in seconds between operations</span>
<span class="sd">        :return: A tuple containing the filename of the exported file and the number of products processed.</span>
<span class="sd">        :rtype: tuple(str, int)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;retailer&#39;</span> <span class="ow">in</span> <span class="n">data</span> <span class="ow">and</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;retailer&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">retailer</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;products&#39;</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">data_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_export_file</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">):</span>
                    <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
                <span class="n">upload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">upload_file_to_s3</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">data_file</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">upload</span><span class="p">:</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">delete_local_file</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">data_file</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">data_file</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;products&#39;</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Upload failed for </span><span class="si">{</span><span class="n">retailer</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Data validation failed for </span><span class="si">{</span><span class="n">retailer</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">Utils</span><span class="o">.</span><span class="n">print_error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">,</span> <span class="n">retailer</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="c1"># Log to DB</span>
            <span class="n">LogHandler</span><span class="o">.</span><span class="n">error_db</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
            <span class="c1"># Log to file</span>
            <span class="n">LogHandler</span><span class="o">.</span><span class="n">error_file</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span></div>


<div class="viewcode-block" id="Ingest.banner_ingest">
<a class="viewcode-back" href="../../tools.html#tools.utils.Ingest.banner_ingest">[docs]</a>
    <span class="k">def</span> <span class="nf">banner_ingest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retailer</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">delay</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract, prepare and upload data to a S3 bucket. Move the file to processed</span>

<span class="sd">        This method processes banner data for a specific retailer. It checks if the retailer&#39;s name matches</span>
<span class="sd">        the one in the data and if the data contains banners. If both conditions are met, it generates an export</span>
<span class="sd">        file, waits for the specified delay, and then uploads the file to an S3 bucket. If the upload is successful,</span>
<span class="sd">        the local file is deleted. If any validation or processing errors occur, they are logged and raised.</span>

<span class="sd">        :param retailer: The name of the retailer.</span>
<span class="sd">        :param data: The data to be processed. In this case, banner data.</span>
<span class="sd">        :param delay: The delay in seconds between operations</span>
<span class="sd">        :return: A tuple containing the filename of the exported file and the number of products processed.</span>
<span class="sd">        :rtype: tuple(str, int)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;retailer&#39;</span> <span class="ow">in</span> <span class="n">data</span> <span class="ow">and</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;retailer&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">retailer</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;banners&#39;</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">data_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_export_banner_file</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">):</span>
                    <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
                <span class="n">upload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">upload_file_to_s3</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">data_file</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">upload</span><span class="p">:</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">delete_local_file</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">data_file</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">data_file</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;banners&#39;</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Upload failed for </span><span class="si">{</span><span class="n">retailer</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Data validation failed for </span><span class="si">{</span><span class="n">retailer</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">Utils</span><span class="o">.</span><span class="n">print_error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">,</span> <span class="n">retailer</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="c1"># Log to DB</span>
            <span class="n">LogHandler</span><span class="o">.</span><span class="n">error_db</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
            <span class="c1"># Log to file</span>
            <span class="n">LogHandler</span><span class="o">.</span><span class="n">error_file</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span></div>


<div class="viewcode-block" id="Ingest.upload_banners_to_s3">
<a class="viewcode-back" href="../../tools.html#tools.utils.Ingest.upload_banners_to_s3">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">upload_banners_to_s3</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">bucket</span><span class="p">,</span> <span class="n">screenshot_name</span><span class="p">,</span> <span class="n">screenshot_path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Uploads a file to an AWS S3 bucket.</span>

<span class="sd">        This method uploads a file to an AWS S3 bucket.</span>
<span class="sd">        If the debug mode is disabled, the file is uploaded to the designated S3 bucket.</span>
<span class="sd">        The filename used for the S3 object is prefixed with &#39;Ready/&#39;.</span>
<span class="sd">        Upon successful upload, a debug message is printed indicating the filename uploaded to S3.</span>
<span class="sd">        Returns True if the upload is successful, otherwise returns False.</span>

<span class="sd">        :param retailer: The name of the retailer.</span>
<span class="sd">        :param bucket: Destination S3 bucket</span>
<span class="sd">        :param screenshot_name: Screenshot file name</span>
<span class="sd">        :param screenshot_path: Path to destination</span>
<span class="sd">        :return: True if the upload is successful, False otherwise.</span>
<span class="sd">        :rtype: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">debug</span> <span class="o">=</span> <span class="n">Utils</span><span class="o">.</span><span class="n">setup_debugging</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">DEBUG</span><span class="p">:</span>
                <span class="n">s3</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span>
                    <span class="s1">&#39;s3&#39;</span><span class="p">,</span>
                    <span class="n">region_name</span><span class="o">=</span><span class="n">AWS_BANNER_SCREENSHOTS_REGION</span><span class="p">,</span>
                    <span class="n">aws_access_key_id</span><span class="o">=</span><span class="n">AWS_BANNER_SCREENSHOTS_ACCESS_KEY_ID</span><span class="p">,</span>
                    <span class="n">aws_secret_access_key</span><span class="o">=</span><span class="n">AWS_BANNER_SCREENSHOTS_SECRET_ACCESS_KEY</span>
                <span class="p">)</span>

                <span class="n">s3</span><span class="o">.</span><span class="n">Bucket</span><span class="p">(</span><span class="n">bucket</span><span class="p">)</span><span class="o">.</span><span class="n">put_object</span><span class="p">(</span>
                    <span class="n">Key</span><span class="o">=</span><span class="n">screenshot_path</span><span class="p">,</span>
                    <span class="n">Body</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="n">screenshot_name</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">),</span>
                    <span class="n">ContentType</span><span class="o">=</span><span class="s1">&#39;image/jpeg&#39;</span><span class="p">,</span>
                    <span class="n">ACL</span><span class="o">=</span><span class="s1">&#39;public-read&#39;</span>
                <span class="p">)</span>
                <span class="n">Utils</span><span class="o">.</span><span class="n">print_debug</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">retailer</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;File uploaded: </span><span class="si">{</span><span class="n">screenshot_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">LogHandler</span><span class="o">.</span><span class="n">error_db</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
            <span class="c1"># Log to file</span>
            <span class="n">LogHandler</span><span class="o">.</span><span class="n">error_file</span><span class="p">(</span><span class="n">retailer</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
            <span class="n">Utils</span><span class="o">.</span><span class="n">print_error</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">retailer</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Brand Nudge.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>